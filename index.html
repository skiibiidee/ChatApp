<!doctype html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    html {
      font-size: 16px;
    }

    body {
      font-size: 1rem;
      overflow: hidden;
    }

    h1 {
      font-size: 2rem;
    }

    h2 {
      font-size: 1.5rem;
    }

    p {
      font-size: 1rem;
    }

    button,
    input,
    select {
      font-size: 1rem;
    }

    @media (min-width: 1200px) {
      html {
        font-size: 20px;
      }

      .container {
        max-width: 1140px;
        padding: 0 2rem;
      }

      h1 {
        font-size: 3rem;
      }

      h2 {
        font-size: 2rem;
      }

      p {
        font-size: 1.25rem;
      }
    }

    .down-arrow-btn {
      position: absolute;
      right: 20px;
      width: 50px;
      height: 50px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s;
    }

    .down-arrow-btn:hover {
      background-color: rgba(0, 0, 0, 0.7);
    }




    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }

      to {
        opacity: 0;
        transform: translateY(20px);
      }
    }

    .animate-fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }

    .animate-fade-out {
      animation: fadeOut 0.3s ease-in-out;
    }
  </style>
</head>

<body class="min-h-screen transition-colors duration-300 bg-gray-900 text-white">
  <!-- Login Page -->
  <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md space-y-6">
      <h1 class="text-3xl font-bold text-white">
        Welcome Back
      </h1>
      <p class="text-gray-400">
        Please enter your details
      </p>
      <div class="space-y-4">
        <div>
          <label for="username" class="block text-gray-400 font-medium mb-2">Username</label>
          <input type="text" id="username" class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" placeholder="Enter your username" maxlength="32" />
        </div>
        <div>
          <label for="password" class="block text-gray-400 font-medium mb-2">Password</label>
          <input type="password" id="password" class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" placeholder="Enter your password" maxlength="32" />
        </div>
        <div class="flex gap-4">
          <button id="login-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
            Login
          </button>
          <button id="register-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
            Register
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Chat Page -->
  <div id="chat-page" class="hidden h-screen flex">
    <!-- Sidebar -->
    <div class="w-1/3 bg-gray-800 border-r border-gray-700 flex flex-col">
      <!-- Sidebar Header -->
      <div class="p-4 border-b border-gray-700 flex items-center justify-between"><button class="flex items-center gap-2 text-gray-400 text-sm" id="home-btn">

          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
            <polyline points="9 22 9 12 15 12 15 22" />
          </svg></button>
        <button class="flex items-center gap-2 text-gray-400 text-sm" id="username-display-btn">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          <span id="user-info">username</span>
        </button>
      </div>

      <!-- Create Chat Button -->
      <button id="create-chat-btn" class="m-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 min-w-[48px]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        <span class="whitespace-nowrap overflow-hidden transition-all duration-200 sm:w-auto w-0 text-center">Create New Chat</span>
      </button>

      <!-- Chat List -->
      <div class="chat-list flex-1 overflow-y-auto">
        <!-- Chat items will be dynamically inserted here -->
      </div>
    </div>
    <!-- Main Chat Area -->
    <div class="w-2/3 flex flex-col">
      <!-- Chat Header -->
      <button id="chat-header" class="chat-header bg-gray-800 shadow-sm p-4 flex items-center justify-between">
        <div class="flex items-center gap-4 overflow-hidden">
          <h1 id="chat-title" class="text-xl font-semibold truncate">Chat Name</h1>
        </div>
        <div class="text-sm text-gray-400 inline-flex items-center">
          <span id="chat-members" class="">
          </span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
      </button>
      <!-- Messages Container -->
      <div class="flex-1 bg-gray-900 px-4 py-2 overflow-hidden flex flex-col">
        <div id="message-container" class="flex-1 overflow-y-auto"> </div>
        <button id="downArrowBtn" class="down-arrow-btn">â†“</button>
      </div>
      <!-- Message Input -->
      <div id="form-div" class="bg-gray-800 border-t border-gray-700 p-4">
        <form id="message-form" class="flex gap-3" autocomplete="off">
          <input type="text" id="message-input" class="flex-1 p-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" placeholder="Type your message..." maxlength="250" />
          <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 rounded-lg transition duration-200">
            Send
          </button>
        </form>
      </div>
    </div>
  </div>
  <!-- Chat Settings Modal -->
  <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-gray-800 p-6 m-5 rounded-lg max-w-lg w-full">
      <div class="flex items-center justify-between mb-5">
        <div class="inline-flex items-end">
          <span class="text-xl font-bold text-white" id="settings-chat-name">Chat Name</span>
          <button id="edit-name-btn" class="px-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 hover:text-white transition-colors duration-200" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20h9" />
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
            </svg>
          </button>
        </div>
        <div class="text-white inline-flex items-center">
          <span id="settings-chat-members" class="text-gray-400 text-sm">0</span>
          <svg xmlns="htwtp://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
      </div>
      <div class="flex items-center w-100 px-4">
        <button id="add-user-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded">
          Add User
        </button>
      </div>
      <div id="chat-details" class="rounded-lg p-4 max-h-60 overflow-y-auto mb-6">
      </div>
      <div class="flex justify-between"><button id="close-settings-btn" class="text-blue-600">
          Close
        </button><button id="delete-chat-btn" class="text-rose-600 font-bold">
          Delete Chat
        </button>
      </div>
    </div>
  </div>

  <!-- User Settings Modal -->
  <div id="user-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-gray-800 p-6 m-5 rounded-lg max-w-lg w-full">
      <!-- Header with Username and Action Buttons -->
      <div class="flex items-center justify-between mb-5">
        <div class="inline-flex items-end">
          <span class="text-xl font-bold text-white" id="settings-username-display">Username</span>
        </div>

        <div class="flex justify-between items-center gap-2 overflow-scroll">
          <button id="logout-btn" class="text-sm text-red-500 hover:text-red-600 font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="25" height="25">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
              <polyline points="16 17 21 12 16 7" />
              <line x1="21" y1="12" x2="9" y2="12" />
            </svg>
          </button>
          <button id="delete-account-btn" class="text-sm bg-red-500 text-grey-600 font-bold rounded p-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="25" height="25">
              <path d="M3 6h18" />
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" />
              <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
              <line x1="10" y1="11" x2="10" y2="17" />
              <line x1="14" y1="11" x2="14" y2="17" />
            </svg>
          </button>
        </div>
      </div>

      <!-- User Details Section -->
      <div class="space-y-4 mb-6">
        <div class="flex flex-col space-y-1">
          <span class="text-gray-400 text-sm">User ID</span>
          <span class="text-white" id="settings-user-id">usr_123456789</span>
        </div>

        <div class="flex flex-col space-y-1">
          <span class="text-gray-400 text-sm">Account Created</span>
          <span class="text-white" id="settings-user-creation">January 1, 2024 at 00:00 UTC</span>
        </div>

        <div class="flex flex-col space-y-1">
          <span class="text-gray-400 text-sm">Account Status</span>
          <span class="text-green-500 flex items-center gap-2" id="account-status">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            Active
          </span>
        </div>
      </div>

      <!-- Footer -->
      <div class="flex justify-between items-center">
        <button id="settings-modal-close-btn" class="w-full text-gray-400 hover:text-gray-300 px-4 py-2 rounded border-2 border-gray-400 hover:border-gray-300 text-center">
          Close
        </button>
      </div>

    </div>
  </div>
  <div id="toast-container" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;"></div>
  <script>
    const socket = io();
    const rootUrl = "";

    const version = "v0.7.3";
    let currentUser = null;
    let currentChat = null;
    let userChats = [];
    let unread = 0;

    let msgsSinceLastShow = 0;
    let msgLastTimestamp = 0;
    let lastMessageDay = null;

    let userColors = new Map();

    const userColorsList = [
      "#E53E3E",
      "#38A169",
      "#805AD5",
      "#D69E2E",
      "#3182CE",
      "#DD6B20",
      "#319795",
      "#B83280",
      "#5A67D8",
      "#718096",
    ];

    let nextColorIndex = 0;
    let lastMessageSender = null;

    const savedUsername = localStorage.getItem("username");
    const savedPassword = localStorage.getItem("password");
    if (savedUsername && savedPassword) {
      document.getElementById("username").value = savedUsername;
      document.getElementById("password").value = savedPassword;
    }

    socket.on("version", async (v) => {
      if (v !== version) {
        if (rootUrl !== "") {
          const confirmed = await createConfirmModal(`Client out of date. Server running ${v} while client on ${version}. Download new version from "${rootUrl}"?`)
          if (confirmed) {
            window.open(`${rootUrl}/download`, target = "_blank")
          }
        } else {
          const confirmed = await createConfirmModal(`Client out of date. Server running ${v} while client on ${version}. Reload?`)
          if (confirmed) {
            window.location.reload();
          }
        }
      }
    })
    socket.on("connect", () => {
      console.log("Connected to the server.");

      showToast("Connected", 5000)
      document
        .getElementById("chat-page")
        .classList.add("hidden");
      document
        .getElementById("login-page")
        .classList.remove("hidden");
      currentUser = null;
      currentChat = null;
      userChats = [];
      unread = 0;

      msgsSinceLastShow = 0;
      msgLastTimestamp = 0;
      lastMessageDay = null;

      document.title = `Chat${unread !== 0 ? ` (${unread})` : ""}`;
      userColors = new Map();
      const savedUsername = localStorage.getItem("username");
      const savedPassword = localStorage.getItem("password");
      if (savedUsername && savedPassword) {
        document.getElementById("username").value = savedUsername;
        document.getElementById("password").value = savedPassword;
      }
    })

    function triggerScroll() {
      const element = document.getElementById("message-container")
      if (
        Math.abs(
          element.scrollHeight -
          element.scrollTop -
          element.clientHeight,
        ) < element.clientHeight
      ) {
        scroll()
      }
    }

    function scroll() {
      const element = document.getElementById("message-container")
      element.scrollTo({
        top: element.scrollHeight,
        behavior: "smooth",
      });
    }

    function getColorForUser(username) {
      if (!userColors.has(username)) {
        userColors.set(username, userColorsList[nextColorIndex]);
        nextColorIndex =
          (nextColorIndex + 1) % userColorsList.length;
      }
      return userColors.get(username);
    }

    function appendMessage(message, bulk) {
      if (lastMessageDay !== formatDateToYearMonthDay(new Date(message.timestamp))) {
        lastMessageDay = formatDateToYearMonthDay(new Date(message.timestamp))
        addTimeDisplay(message.timestamp)
      }
      const messageContainer =
        document.getElementById("message-container");
      if (
        message.username == "SERVER" &&
        message.senderId == "SERVER"
      ) {
        const messageElement = document.createElement("div");
        messageElement.classList.add("w-100", "mt-4", "break-all")
        messageElement.innerHTML = `<div class="p-1 rounded-lg w-80 mx-auto text-center text-sm text-gray-200 bg-gray-700">
                                                                  <div class="text-sm">
                                                                      ${message.message}
                                                                  </div>
                                                              </div>`;
        messageContainer.appendChild(messageElement);
        lastMessageSender = null;
        if (!bulk) {
          triggerScroll();
        }
        return;
      }
      const isSent = message.username === currentUser?.username;
      let showUsername = message.username !== lastMessageSender || message.timestamp - msgLastTimestamp >= 5 * 60 * 1000;

      if (!showUsername) msgsSinceLastShow++;
      if (msgsSinceLastShow > 20 || showUsername) {
        showUsername = true;
        msgsSinceLastShow = 0;
      }
      const msgOuter = document.createElement("div");
      msgOuter.classList.add("w-100", "flex");
      const messageElement = document.createElement("div");
      messageElement.classList.add(
        "message-bubble",
        "p-2",
        "rounded-lg",
        "max-w-[80%]",
        "min-w-[25ch]",
        "inline-block",
        "w-auto",
        "justify-center",
        "relative" // To position the triangle relative to the message bubble
      );

      if (isSent) {
        messageElement.classList.add(
          "sent",
          "right-0",
          "bg-blue-600",
          "text-white",
          "ml-auto",
        );
        msgOuter.classList.add("justify-end");
        messageElement.style = "border-top-right-radius: 0%;";
      } else {
        messageElement.classList.add(
          "received",
          "bg-gray-700",
        );
        messageElement.style = "border-top-left-radius: 0%;";

      }

      if (showUsername) {
        messageElement.classList.add("mt-4");
      } else {
        messageElement.classList.add("mt-2");
      }

      messageElement.innerHTML = `
  ${
    showUsername
      ? `
      <div class="mb-1 flex items-center justify-between">
          <span class="${
            isSent
              ? `text-white text-base font-bold`
              : `text-gray-400 text-base font-bold" style="color: ${getColorForUser(message.username)}`
          }">${isSent ? "You" : message.username}</span>
          <span class="ml-5 text-sm text-gray-300">
            ${getTimestamp(message.timestamp)}
          </span>
      </div>`
      : ""
  }
  <div class="text-base text-wrap break-words ${isSent ? "text-white" : "text-white"}">
    ${message.message}
  </div>
`;

      msgOuter.appendChild(messageElement);
      messageContainer.appendChild(msgOuter);

      lastMessageSender = message.username;
      msgLastTimestamp = message.timestamp;
      if (!bulk) {
        triggerScroll();
      }

      function addTimeDisplay(timestamp) {
        const d = new Date(timestamp);

        const messageElement = document.createElement("div");
        messageElement.classList.add("w-100", "mt-4", "break-all")
        messageElement.innerHTML = `<div class="p-1 rounded-lg w-40 mx-auto text-center text-sm text-gray-100 bg-gray-500">
                                                                  <div class="text-sm">
                                                                      ${d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                                                                  </div>
                                                              </div>`;
        document.getElementById("message-container").appendChild(messageElement);
        lastMessageSender = null;
      }

      function formatDateToYearMonthDay(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-based, so add 1
        const day = String(date.getDate()).padStart(2, '0'); // Pad single-digit days with leading zero

        return `${year}${month}${day}`; // Format as yyyyMMdd
      }

      function getTimestamp(timestamp) {
        const d = new Date(timestamp);
        const now = new Date();

        // Helper function to format date as dd/mm/yy hh:mm
        function formatDate(date) {
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = String(date.getFullYear()).slice(2); // Get last 2 digits of year
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        // Check if the date is today
        const isSameDay = d.toDateString() === now.toDateString();
        if (isSameDay) {
          return formatDate(d).slice(9); // Only return the time part (hh:mm)
        }

        // Check if the date is yesterday
        const yesterday = new Date(now);
        yesterday.setDate(now.getDate() - 1);
        const isYesterday = d.toDateString() === yesterday.toDateString();
        if (isYesterday) {
          return `Yesterday at ${formatDate(d).slice(9)}`; // Only return the time part (hh:mm)
        }

        // Check if the date is within the past 7 days but not today or yesterday
        const weekAgo = new Date(now);
        weekAgo.setDate(now.getDate() - 7);
        if (d > weekAgo) {
          // Get the day of the week (e.g., "Monday")
          const dayOfWeek = d.toLocaleString('en-us', {
            weekday: 'long'
          });
          return `${dayOfWeek} at ${formatDate(d).slice(9)}`; // Return "Day at hh:mm"
        }

        // If the date is older than a week, return the formatted date (dd/mm/yy hh:mm)
        return formatDate(d);
      }
    }

    function renderChatList() {
      const chatList = document.querySelector(".chat-list");
      chatList.innerHTML = "";

      document.getElementById("chat-details").innerHTML =
        getChatDetails(currentChat);
      userChats.forEach((chat) => {
        const chatElement = document.createElement("div");
        chatElement.classList.add(
          "chat-item",
          "p-4",
          "border-b",
          "border-gray-700",
          "cursor-pointer",
        );

        if (currentChat && currentChat?.id === chat.id) {
          chatElement.classList.add("bg-gray-700");
        }
        const messageSender = chat.lastMessage ?
          chat.lastMessage.username + ": " :
          ""
        const lastMessage = chat.lastMessage ?
          chat.lastMessage.message :
          "No messages yet";

        chatElement.innerHTML = `
                                            <div class="font-semibold text-wrap break-all overflow-hidden truncate">${chat.name.slice(0,25)}${chat.name.length>25?"...":""}</div>
                                            <div class="text-sm text-gray-400 text-wrap break-all overflow-hidden truncate">${messageSender}${lastMessage.slice(0,20)}${lastMessage.length>20?"...":""}</div>
                                            <div class="text-xs text-gray-500 text-wrap break-all overflow-hidden truncate">${chat.participants.length} member${chat.participants.length>1?"s":""}</div>
                                        `;
        chatElement.addEventListener("click", () => {
          switchToChat(chat);
          document.getElementById("chat-details").innerHTML =
            getChatDetails(chat);
        });

        chatList.appendChild(chatElement);
      });
    }

    function getChatDetails(chat) {
      if (chat) {
        return chat.participantsUsernames.sort((a, b) => {
            if (a.id === chat.admin.id) return -1;
            if (b.id === chat.admin.id) return 1;
            if (a.id === currentUser.id) return -1;
            if (b.id === currentUser.id) return 1;
            return 0;
          })
          .map((p) => {
            return `
                                      <div class="flex justify-between items-center mb-2 p-3 bg-gray-700 rounded">
                                          <div class="inline-flex items-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-5 w-5 mr-3 text-gray-400">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                          <span class="text-white font-medium">${p.username}</span></div>
                                          <div class="flex items-center gap-2">
                                              <span class="text-gray-400 text-sm">ID: ${p.id}</span>
                                              ${p.id === chat.admin.id?
                                              `
                                              <span class="bg-red-600 text-white text-xs font-semibold px-2 py-1 rounded">Admin</span>`:
                                              `${p.id === currentUser.id?`
                                                                              <button class="btn bg-red-900 text-white text-xs font-semibold px-2 py-1 rounded" onclick="leaveChat()">Leave</button>`:`${p.id !== chat.admin.id && currentUser.id === chat.admin.id?`<button class="btn bg-red-900 text-white text-xs font-semibold px-2 py-1 rounded" onclick="removeUser('${p.id}','${p.username}')">Remove</button>`:""}`}
                                                                              `}
                                          </div>
                                      </div>`
          }).join("")
      } else {
        return "";
      }
    }

    async function removeUser(id, username) {
      const confirmed = await createConfirmModal(`Are you sure to remove ${username} from the chat? `)
      const chatId = currentChat?.id;
      if (confirmed && chatId) {

        socket.emit("remove_user_from_chat", {
          chatId,
          userIdToRemove: id
        })
      }
    }

    function leaveChat() {
      if (currentChat) {
        socket.emit("leave_chat", {
          chatId: currentChat.id
        });
      }

    }

    function switchToChat(chat) {

      msgsSinceLastShow = 0;
      msgLastTimestamp = 0;
      lastMessageDay = null;

      unread = 0;
      document.title = "Chat";
      document.getElementById("message-container").innerHTML = "";
      document
        .querySelector(".chat-header")
        .classList.remove("hidden");
      document.getElementById("form-div").classList.remove("hidden");
      currentChat = chat;
      socket.emit("join_chat", {
        chatId: chat.id
      });

      document.getElementById("chat-details").innerHTML =
        getChatDetails(chat);
      const isAdmin = chat.admin.id === currentUser.id;
      if (isAdmin) {

        document.getElementById("delete-chat-btn").disabled =
          false;

        document.getElementById("delete-chat-btn").classList.remove("hidden");

      } else {

        document.getElementById("delete-chat-btn").disabled =
          true;

        document.getElementById("delete-chat-btn").classList.add("hidden");

      }
      document.getElementById("chat-title").textContent =
        chat.name;
      document.getElementById("settings-chat-name").textContent = chat.name;

      document.getElementById("chat-members").textContent =
        chat.participants.length;
      document.getElementById("settings-chat-members").textContent = chat.participants.length;
    }

    function toHome() {
      socket.emit("to_home");
      currentChat = null;
      document.getElementById("message-container").innerHTML =
        userChats.length == 0 ?
        `<div class="flex flex-col items-center justify-center h-screen bg-gray-900 text-white">
                                       <h1 class="text-5xl font-bold mb-4">Skibidi Chat</h1>
                                       <p class="text-xl mb-2">To start, create a new chat or ask other users to add you to a existing chat.</p>
                                       <p class="text-sm">Made by <a href="https://github.com/skiibiidee/">@skiibiidee</a></p>
                                   </div>` :
        `<div class="flex flex-col items-center justify-center h-screen bg-gray-900 text-white">
                                       <h1 class="text-5xl font-bold mb-4">Welcome Back</h1>
                                       <p class="text-xl mb-2">Skibidi Chat is still in development.</p>
                          <a class="px-4 py-2 bg-purple-700 rounded-5 rounded mb-3 mt-2" style="text-decoration:none;" href="${rootUrl}/download" target="_blank">Download html file</a>
                                       <p class="text-sm">Made by <a href="https://github.com/skiibiidee/">@skiibiidee</a></p>
                                   </div>`;
      document.querySelector(".chat-header").classList.add("hidden");
      document.getElementById("form-div").classList.add("hidden");
      document.getElementById("settings-modal").classList.add("hidden")
      document.getElementById("user-settings-modal").classList.add("hidden")

      document.getElementById("chat-title").textContent =
        "Chat Name";
      document.getElementById(
        "chat-members",
      ).textContent = "0";
      document.getElementById("settings-chat-members").textContent = "0";
      document.getElementById("settings-chat-name").textContent = "Chat Name";

    }

    const toastContainer = document.getElementById("toast-container")

    function showToast(message, duration) {

      const toast = document.createElement('div');
      const toastId = 'toast-' + Date.now();
      toast.id = toastId;
      toast.className = 'bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg mb-2 animate-fade-in';
      toast.textContent = message;

      toastContainer.appendChild(toast);

      setTimeout(() => {
        const toastElement = document.getElementById(toastId);
        if (toastElement) {
          toastElement.classList.add('animate-fade-out');
          setTimeout(() => {
            if (document.getElementById(toastId)) {
              toastContainer.removeChild(toastElement);
            }
          }, 200);
        }
      }, duration || 3000);
    }

    function createConfirmModal(message) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.id = 'confirm-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

        const modalContent = `
            <div class="bg-gray-800 p-6 rounded-lg max-w-lg w-full">
                <div class="mb-4">
                    <h2 class="text-xl font-bold text-white">${message}</h2>
                </div>
                <div class="flex justify-end gap-2">
                    <button 
                        id="confirm-modal-cancel" 
                        class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded transition duration-200"
                    >
                        Cancel
                    </button>
                    <button 
                        id="confirm-modal-confirm" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition duration-200"
                    >
                        Confirm
                    </button>
                </div>
            </div>
        `;

        modal.innerHTML = modalContent;
        document.body.appendChild(modal);

        document.getElementById('confirm-modal-confirm').addEventListener('click', () => {
          document.body.removeChild(modal);
          resolve(true);
        });

        document.getElementById('confirm-modal-cancel').addEventListener('click', () => {
          document.body.removeChild(modal);
          resolve(false);
        });

        modal.addEventListener('click', (e) => {
          if (e.target.id === 'confirm-modal') {
            document.body.removeChild(modal);
            resolve(false);
          }
        });

      });
    }

    function createPromptModal(message, defaultValue = '', maxLength = 250) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.id = 'prompt-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

        const modalContent = `
            <div class="bg-gray-800 p-6 rounded-lg max-w-lg w-full">
                <div class="mb-4">
                    <h2 class="text-xl font-bold text-white mb-4">${message}</h2>
                    <input 
                        type="text" 
                        id="prompt-modal-input"
                        class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                        value=""
                        placeholder="${defaultValue}"
                        maxlength="${maxLength}"
                    />
                </div>
                <div class="flex justify-end gap-2">
                    <button 
                        id="prompt-modal-cancel" 
                        class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded transition duration-200"
                    >
                        Cancel
                    </button>
                    <button 
                        id="prompt-modal-submit" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition duration-200"
                    >
                        Submit
                    </button>
                </div>
            </div>
        `;

        modal.innerHTML = modalContent;
        document.body.appendChild(modal);

        const input = document.getElementById('prompt-modal-input');
        input.focus();

        function handleSubmit() {
          const value = document.getElementById('prompt-modal-input').value;
          document.body.removeChild(modal);
          resolve(value);
        }

        document.getElementById('prompt-modal-submit').addEventListener('click', handleSubmit);

        document.getElementById('prompt-modal-cancel').addEventListener('click', () => {
          document.body.removeChild(modal);
          resolve(null);
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            handleSubmit();
          }
        });

        modal.addEventListener('click', (e) => {
          if (e.target.id === 'prompt-modal') {
            document.body.removeChild(modal);
            resolve(null);
          }
        });


      });
    }

    socket.on("chats_list", (chats) => {
      if (userChats.length == 0) {
        userChats = chats;

        toHome();
      } else {
        userChats = chats;
      }

      const index = userChats.findIndex((chat) => chat.id === currentChat?.id)
      if (index > -1) {
        currentChat = userChats[index];
        document.getElementById("chat-title").textContent =
          currentChat.name;
        document.getElementById(
          "chat-members",
        ).textContent = currentChat.participants.length;
        document.getElementById("settings-chat-members").textContent = currentChat.participants.length;
        document.getElementById("settings-chat-name").textContent = currentChat.name;
      }

      renderChatList();

    });

    socket.on("chat_messages", ({
      chatId,
      messages
    }) => {
      if (currentChat && currentChat?.id === chatId) {
        const messageContainer =
          document.getElementById("message-container");
        messageContainer.innerHTML = "";
        lastMessageSender = null;
        messages.forEach((message) => {
          appendMessage(message, true);
        });
        scroll()
      }
    });

    socket.on("message_received", ({
      chatId,
      message
    }) => {
      if (currentChat && currentChat?.id === chatId) {
        appendMessage(message);
        if (!document.hasFocus()) {
          unread++;
          document.title = `Chat${unread !== 0 ? ` (${unread})` : ""}`;
        }
      }
    });

    socket.on("authenticated", (user) => {
      currentUser = user;
      document.getElementById("login-page").classList.add("hidden");
      document.getElementById("chat-page").classList.remove("hidden");
      document.getElementById("user-info").textContent =
        `${user.username}`;
      getColorForUser(user.username);
      document.getElementById("settings-username-display").textContent = user.username;
      document.getElementById("settings-user-id").textContent = user.id;
      document.getElementById("settings-user-creation").textContent = new Date(user.creationTime).toString();
      toHome();
      showToast("Logged in successfully.", 5000)

    });

    socket.on("registered", (user) => {
      currentUser = user;
      document.getElementById("login-page").classList.add("hidden");
      document.getElementById("chat-page").classList.remove("hidden");
      document.getElementById("user-info").textContent =
        `${user.username}`;
      getColorForUser(user.username);
      document.getElementById("settings-username-display").textContent = user.username;
      document.getElementById("settings-user-id").textContent = user.id;
      document.getElementById("settings-user-creation").textContent = new Date(user.creationTime).toString();
      toHome();
      showToast("Registered and logged in successfully.", 5000)

    });

    socket.on("registration_failed", () => {
      showToast("Registration failed. Try another username.");
    });

    socket.on("authentication_failed", () => {
      showToast("Authentication failed. Wrong password or username.");
    });

    socket.on("add_user_failed", () => {
      showToast("Failed to add user to chat.");
    });

    socket.on("user_added", (data) => {
      const {
        chatId,
        chat,
        user
      } = data;

      const index = userChats.findIndex((chat) => chat.id === currentChat?.id)
      if (index > -1) {
        userChats[index] = chat;
        currentChat = userChats[index];
        document.getElementById("chat-title").textContent =
          currentChat.name;
        document.getElementById(
          "chat-members",
        ).textContent = currentChat.participants.length;
        document.getElementById("settings-chat-members").textContent = currentChat.participants.length;
      }
      renderChatList();

      document
        .getElementById("settings-modal")
        .classList.add("hidden");
      showToast(`User ${user.username} has been added to ${chatId}.`)
    });

    socket.on("chat_deleted", ({
      chatId
    }) => {
      showToast(`Chat of id: ${chatId} has been deleted.`);

      document
        .getElementById("settings-modal")
        .classList.add("hidden");
      toHome();
    });

    socket.on("delete_chat", () => {
      showToast(`Chat of id: ${chatId} failed to delete.`);
    });

    socket.on("chat_created", (chat) => {
      if (userChats.length == 0) {
        userChats.push(chat);
      }
      switchToChat(chat);
    });

    socket.on("left_chat", ({
      chatId
    }) => {
      showToast(`You left chat of id: ${chatId}`);

      document
        .getElementById("settings-modal")
        .classList.add("hidden");
      toHome();
    });

    socket.on("leave_chat_failed", () => {
      showToast(`Failed to leave chat.`);
    });

    socket.on("account_deleted", () => {
      showToast("Account deleted.")
      document.getElementById('logout-btn').click()
    })

    socket.on("account_failed_to_delete", () => {
      showToast("Account failed to delete.")
    })
    socket.on("chat_name_edited", () => {
      showToast("Chat name edited.")
    })
    socket.on("chat_name_editing_failed", () => {
      showToast("Chat name failed to edit.")

    })
    socket.on("user_removed", (data) => {
      const {
        user,
        chatId
      } = data;
      showToast(`User ${user.username} has been removed from ${chatId}`)
    })
    socket.on("remove_user_failed", (data) => {
      const {
        user,
        chatId
      } = data;
      showToast(`Failed to remove user ${user.username} from ${chatId}`)
    })
    socket.on("removed_from_chat", (data) => {
      const {
        chatId
      } = data;
      showToast(`You have been removed from ${chatId} by the Admin.`, 5000)
      if (chatId === currentChat?.id) {
        toHome()
      }
    })

    document
      .getElementById("login-btn")
      .addEventListener("click", () => {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        socket.emit("login", {
          username,
          password,
        });
        localStorage.setItem("username", username);
        localStorage.setItem("password", password);
      });

    document
      .getElementById("register-btn")
      .addEventListener("click", () => {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        socket.emit("register", {
          username,
          password,
        });
      });

    document
      .getElementById("create-chat-btn")
      .addEventListener("click", async () => {
        const chatName = await createPromptModal("Enter chat name:", "Chat Name", 30);
        if (chatName) {
          socket.emit("create_chat", {
            name: chatName.slice(0, 30)
          });
        }
      });

    document
      .getElementById("chat-header")
      .addEventListener("click", () => {
        if (!currentChat) return;
        document
          .getElementById("settings-modal")
          .classList.remove("hidden");
      });

    document
      .getElementById("close-settings-btn")
      .addEventListener("click", () => {
        document
          .getElementById("settings-modal")
          .classList.add("hidden");
      });

    document
      .getElementById("add-user-btn")
      .addEventListener("click", async () => {
        const username = await createPromptModal("Enter username to add:", "", 32);
        if (username && currentChat) {
          socket.emit("add_user_to_chat", {
            chatId: currentChat.id,
            username: username.slice(0, 32),
          });
        }
      });
    document
      .getElementById("delete-chat-btn")
      .addEventListener("click", async () => {
        const confirmed = await createConfirmModal("Are you sure you want to delete this chat?");
        if (confirmed) {
          if (currentChat) {
            socket.emit("delete_chat", {
              chatId: currentChat.id,
            });
          }
        }
      });

    document
      .getElementById("logout-btn")
      .addEventListener("click", () => {
        socket.disconnect();
        socket.connect();
        document
          .getElementById("chat-page")
          .classList.add("hidden");
        document
          .getElementById("settings-modal")
          .classList.add("hidden");
        document
          .getElementById("user-settings-modal")
          .classList.add("hidden");
        document
          .getElementById("login-page")
          .classList.remove("hidden");
        showToast("Logged out.", 3000)
      });

    document
      .getElementById("delete-account-btn")
      .addEventListener("click", async () => {
        const confirmed = await createConfirmModal("Are you sure you want to delete your account? All chats where you are the admin will be deleted.")
        if (confirmed) {
          socket.emit("delete_account");
        }
      });

    document
      .getElementById("message-form")
      .addEventListener("submit", (e) => {
        e.preventDefault();
        unread = 0;
        document.title = "Chat";
        const messageInput =
          document.getElementById("message-input");
        const message = messageInput.value.trim().slice(0, 250);
        if (message && currentUser) {
          socket.emit("send_message", {
            message,
          });
          messageInput.value = "";
        }
      });
    document
      .getElementById("home-btn")
      .addEventListener("click", () => {
        toHome()
      })
    document
      .getElementById("username-display-btn")
      .addEventListener("click", () => {

        document
          .getElementById("user-settings-modal")
          .classList.remove("hidden");

      })
    document
      .getElementById("settings-modal-close-btn")
      .addEventListener("click", () => {

        document
          .getElementById("user-settings-modal")
          .classList.add("hidden");

      })
    document
      .getElementById("downArrowBtn")
      .addEventListener("click", () => {
        scroll()
      })
    document.getElementById("message-container")
      .addEventListener("scroll", (event) => {
        const downArrowBtn = document
          .getElementById("downArrowBtn");
        const messageContainer = document.getElementById("message-container")
        const scrolledAllTheWay = messageContainer.scrollHeight -
          messageContainer.scrollTop -
          messageContainer.clientHeight <= 0;
        if (scrolledAllTheWay) {
          downArrowBtn.classList.add("hidden")
        } else {
          downArrowBtn.classList.remove("hidden")

        }
      })
    document.getElementById("edit-name-btn").addEventListener("click", async () => {
      if (currentChat) {
        const newName = await createPromptModal("Enter chat name:", "Chat Name", 30);
        if (newName) {
          const confirmed = await createConfirmModal(`Are you sure you want to change the chat name to "${newName.slice(0, 30)}"?`)
          if (confirmed) {
            socket.emit("edit_chat_name", {
              newName: newName.slice(0, 30),
              chatId: currentChat.id
            })
          }
        }
      }
    })

    let focused = true;
    setInterval(() => {
      if (focused !== document.hasFocus()) {
        focused = document.hasFocus()
        if (focused) {
          unread = 0;
          document.title = "Chat";
        }
      }
    }, 1000)
  </script>
</body>

</html>
