<!doctype html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Chat</title>
  <meta name="description" content="Skibidi Chat - A real-time chat application.">
  <meta name="keywords" content="Chat, Real-time, WebSocket, Messaging">
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" type="image/x-icon" href="/favicon-512x512.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.0/purify.min.js"></script>

  <style>
    * {
      box-sizing: border-box
    }

    html {
      font-size: 16px
    }

    body {
      font-size: 1rem;
      overflow: hidden
    }

    h1 {
      font-size: 2rem
    }

    h2 {
      font-size: 1.5rem
    }

    p {
      font-size: 1rem
    }

    button,
    input,
    select {
      font-size: 1rem
    }

    .down-arrow-btn:hover {
      background-color: rgba(0, 0, 0, .7)
    }

    @media (min-width:1200px) {
      html {
        font-size: 20px
      }

      .container {
        max-width: 1140px;
        padding: 0 2rem
      }

      h1 {
        font-size: 3rem
      }

      h2 {
        font-size: 2rem
      }

      p {
        font-size: 1.25rem
      }
    }

    @media only screen and (max-width: 600px) {
      #right-pane {
        display: none;
        width: 100%;
      }

      #left-pane {
        width: 100%;
      }

      .mobile-button {
        display: flex;
      }
    }

    @media only screen and (min-width: 600px) {
      .mobile-button {
        display: none;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: translateY(0)
      }

      to {
        opacity: 0;
        transform: translateY(20px)
      }
    }

    .animate-fade-in {
      animation: fadeIn .3s ease-in-out
    }

    .animate-fade-out {
      animation: fadeOut .3s ease-in-out
    }

    @keyframes progress {
      0% {
        width: 0;
      }

      100% {
        width: 100%;
      }
    }

    .animate-progress {
      animation: progress var(--loading-time, 3s) ease-in-out;
    }
  </style>
</head>

<body class="min-h-screen transition-colors duration-300 bg-color-900 text-white">
  <div id="loading-page" class="flex items-center justify-center min-h-screen bg-gray-900 text-white fixed inset-0 transition-opacity duration-500" style="z-index: 9999;">
    <div class="text-center space-y-8">
      <h1 class="text-5xl font-bold">Skibidi Chat App</h1>
      <h4 class="text-2xl" id="loading-page-desc"></h4>
      <div class="w-72 mx-auto h-2 bg-color-700 rounded-full overflow-hidden">
        <div id="load-progress" class="h-full bg-secondarycolor-600 rounded-full"></div>
      </div>
    </div>
  </div>
  <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-color-800 p-8 rounded-xl shadow-2xl w-full max-w-md space-y-6" style="max-height:90vh; overflow-y:scroll">
      <h1 class="text-5xl font-bold mb-4 relative">Skibidi Chat<span class=" inline-block align-text-top m-3 px-2 py-1 text-base font-semibold text-white bg-secondarycolor-600 rounded-full" id="login-page-version"></span></h1>
      <p class="text-gray-400">Please enter your details</p>
      <div class="space-y-4">
        <div><label for="username" class="block text-gray-400 font-medium mb-2">Username</label><input type="text" id="username" class="w-full p-3 border border-color-600 bg-color-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-secondarycolor-500 transition duration-200" placeholder="Enter your username" maxlength="32" minlength="4" autocomplete="off"></div>
        <div><label for="password" class="block text-gray-400 font-medium mb-2">Password</label><input type="password" id="password" class="w-full p-3 border border-color-600 bg-color-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-secondarycolor-500 transition duration-200" placeholder="Enter your password" maxlength="32" minlength="4" autocomplete="off"></div>
        <div class="flex gap-4"><button id="login-btn" class="flex-1 bg-secondarycolor-600 hover:bg-secondarycolor-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200" disabled>Login</button><button id="register-btn" class="flex-1 bg-color-600 hover:bg-color-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200" disabled>Register</button></div>
      </div>
    </div>
  </div>
  <div id="chat-page" class="hidden h-screen flex">
    <div class="w-1/3 bg-color-800 border-r border-color-700 flex flex-col" id="left-pane">
      <div class="p-4 border-b border-color-700 flex items-center justify-between"><button class="flex items-center gap-2 text-gray-400 text-sm" id="home-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
            <polyline points="9 22 9 12 15 12 15 22" />
          </svg></button><button class="flex items-center gap-2 text-gray-400 text-sm" id="username-display-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg><span id="user-info">username</span></button></div><button id="create-chat-btn" class="m-4 bg-secondarycolor-600 hover:bg-secondarycolor-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 min-w-[48px]"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg><span class="whitespace-nowrap overflow-hidden transition-all duration-200 sm:w-auto w-0 text-center">Create New Chat</span></button>
      <div class="chat-list flex-1 overflow-y-auto"></div>
    </div>
    <div class="w-2/3 flex flex-col" id="right-pane">
      <div id="chat-header-whole" class="bg-color-800 shadow-sm p-2 flex items-center justify-between">
        <button id="mobile-back-btn" class="mobile-button font-semibold p-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="35" height="35">
            <path d="M15.5 18l-6-6 6-6" fill="none" stroke="#888888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
        <button id="chat-header" class="flex overflow-hidden pr-2">
          <h1 id="chat-title" class="ml-2 text-xl font-semibold truncate">Chat Title</h1>
        </button>
        <div id="chat-header-members" style="width:25px;height:25px;" class="text-sm text-gray-400 inline-flex items-center m-2">
          <span id="chat-members">1</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
        </div>
      </div>
      <div class="flex-1 bg-color-900 px-4 py-2 overflow-hidden flex flex-col">
        <div id="message-container" class="flex-1 overflow-y-auto"></div><button id="downArrowBtn" class="down-arrow-btn absolute flex right-5" style="
          width: 50px;
          height: 50px;
          background-color: rgba(0, 0, 0, .5);
          color: #fff;
          border: none;
          border-radius: 50%;
          font-size: 24px;
          justify-content: center;
          align-items: center;
          cursor: pointer;
          box-shadow: 0 4px 10px rgba(0, 0, 0, .3);
          transition: background-color .3s;
          ">â†“</button>
      </div>
      <div id="form-div" class="bg-color-800 border-t border-color-700 p-4">
        <form id="message-form" class="flex gap-3" autocomplete="off"><input type="text" id="message-input" class="flex-1 p-3 border border-color-600 bg-color-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-secondarycolor-500 transition duration-200" placeholder="Type your message..." maxlength="250"><button type="submit" id="send-btn" class="bg-secondarycolor-600 hover:bg-secondarycolor-700 text-white font-semibold px-6 rounded-lg transition duration-200">Send</button></form>
      </div>
    </div>
  </div>
  <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-color-800 p-6 m-5 rounded-lg max-w-lg w-full" style="max-height:90vh; overflow-y:scroll">
      <div class="flex items-center justify-between mb-5">
        <div class="inline-flex items-end"><span class="text-xl font-bold text-white" id="settings-chat-name">Chat Name</span><button id="edit-name-btn" class="px-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 hover:text-white transition-colors duration-200" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20h9" />
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
            </svg></button></div>
        <div class="text-white inline-flex items-center"><span id="settings-chat-members" class="text-gray-400 text-sm">0</span><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg></div>
      </div>
      <div class="flex items-center w-100 px-4 mb-4"><button id="add-user-btn" class="w-full bg-secondarycolor-600 hover:bg-secondarycolor-700 text-white font-semibold py-2 px-4 rounded">Add User</button></div>
      <div id="chat-details" class="rounded-lg p-4 max-h-60 overflow-y-auto mb-6"></div>
      <div class="flex justify-between"><button id="close-settings-btn" class="text-blue-600">Close</button><button id="delete-chat-btn" class="text-rose-600 font-bold">Delete Chat</button></div>
    </div>
  </div>
  <div id="user-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-color-800 p-6 m-5 rounded-lg max-w-lg w-full" style="max-height:90vh; overflow-y:scroll">
      <div class="flex items-center justify-between mb-5">
        <div class="inline-flex items-end"><span class="text-xl font-bold text-white" id="settings-username-display">Username</span></div>
        <div class="flex justify-between items-center gap-2 overflow-auto"><button id="logout-btn" class="text-sm text-red-500 hover:text-red-600 font-medium"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="25" height="25">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
              <polyline points="16 17 21 12 16 7" />
              <line x1="21" y1="12" x2="9" y2="12" />
            </svg></button><button id="delete-account-btn" class="text-sm bg-red-500 text-grey-600 font-bold rounded p-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="25" height="25">
              <path d="M3 6h18" />
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" />
              <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
              <line x1="10" y1="11" x2="10" y2="17" />
              <line x1="14" y1="11" x2="14" y2="17" />
            </svg></button></div>
      </div>
      <div class="space-y-4 mb-6">
        <div class="flex flex-col space-y-1"><span class="text-gray-400 text-sm">User ID</span><span class="text-white" id="settings-user-id">usr_123456789</span></div>
        <div class="flex flex-col space-y-1"><span class="text-gray-400 text-sm">Account Created</span><span class="text-white" id="settings-user-creation">January 1, 2024 at 00:00 UTC</span></div>
      </div>
      <div id="settings-container" class="border p-4 rounded-lg mb-6 backdrop-blur-sm overflow-auto">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-white">Settings</h3>
          <button id="fullscreen-btn" class="text-gray-400 hover:text-gray-300 px-2 py-1 border border-color-600 rounded">
            Full Screen
          </button>
        </div>
        <button id="reset-settings-btn" class="w-full px-4 py-2 mb-3 rounded border-2 text-center">Reset Settings</button>
        <div class="overflow-auto max-h-24" id="settings-content">
        </div>
      </div>
      <div class="flex justify-between items-center"><button id="settings-modal-close-btn" class="w-full text-gray-400 hover:text-gray-300 px-4 py-2 rounded border-2 border-color-400 hover:border-color-300 text-center">Close</button></div>
    </div>
  </div>
  <div id="toast-container" style="position:fixed;bottom:5em;left:50%;transform:translateX(-50%);z-index:9998"></div>
  <script>
    // Skibidi Chat Script =>
    const socket = io();
    const rootUrl = "";
    const version = "v0.10.0";
    // Objects
    const settingsInfo = {
      loading_time: {
        default: 0.5,
        type: "number",
        name: "Extra loading time when page open (s)",
        handle: (startUp) => {
          const progressBar = document.getElementById("load-progress");
          progressBar.style.setProperty("--loading-time", `${settings.loading_time}s`);
          progressBar.classList.add("animate-progress");
        }
      },
      toast_duration: {
        default: 3,
        type: "number",
        name: "Toast duration (s)"
      },
      toast_size: {
        default: 20,
        type: "number",
        name: "Toast font size",
        handle: (startUp) => {
          if (!startUp) {
            showToast(`Toast Font Size set to ${settings.toast_size}.`);
          }
        }
      },
      toast_close_btn_initial_opacity: {
        default: 0.5,
        type: "number",
        name: "Toast close button initial opacity"
      },
      default_chat_name: {
        default: "New Chat",
        type: "string",
        name: "Default chat name"
      },
      primary_color: {
        default: "gray",
        type: "drop",
        options: [
          "blue", "slate", "gray", "zinc", "neutral", "stone",
          "red", "orange", "amber", "yellow", "lime",
          "green", "emerald", "teal", "cyan", "sky"
        ],
        name: "Primary color (reload)",
        handle: (startUp) => {
          if (startUp) {
            for (let i = 100; i < 1000; i += 100) {
              const needsReplacing = [`.bg-color-${i}`, `.border-color-${i}`]
              const replacer = [`bg-${settings.primary_color}-${i}`, `border-${settings.primary_color}-${i}`]
              for (let replaceIndex = 0; replaceIndex < needsReplacing.length; replaceIndex++) {
                const elements = document.querySelectorAll(needsReplacing[replaceIndex]);
                for (let elementIndex = 0; elementIndex < elements.length; elementIndex++) {
                  console.log(elements)
                  const element = elements[elementIndex];
                  element.classList.remove(needsReplacing[replaceIndex].slice(1))
                  element.classList.add(replacer[replaceIndex])

                }
              }
            }
          }
        }
      },
      secondary_color: {
        default: "blue",
        type: "drop",
        options: [
          "blue", "slate", "gray", "zinc", "neutral", "stone",
          "red", "orange", "amber", "yellow", "lime",
          "green", "emerald", "teal", "cyan", "sky"
        ],
        name: "Secondary color (reload)",
        handle: (startUp) => {
          if (startUp) {
            for (let i = 100; i < 1000; i += 100) {
              const needsReplacing = [`.bg-secondarycolor-${i}`, `.border-secondarycolor-${i}`]
              const replacer = [`bg-${settings.secondary_color}-${i}`, `border-${settings.secondary_color}-${i}`]
              for (let replaceIndex = 0; replaceIndex < needsReplacing.length; replaceIndex++) {
                const elements = document.querySelectorAll(needsReplacing[replaceIndex]);
                for (let elementIndex = 0; elementIndex < elements.length; elementIndex++) {
                  console.log(elements)
                  const element = elements[elementIndex];
                  element.classList.remove(needsReplacing[replaceIndex].slice(1))
                  element.classList.add(replacer[replaceIndex])

                }
              }
            }
          }
        }
      },
      prevent_right_click: {
        default: false,
        type: "boolean",
        name: "Prevent right click"
      },
      show_send_button: {
        default: true,
        type: "boolean",
        name: "Show Send Button",
        handle: (startUp) => {
          document.getElementById("send-btn").style.display = settings.show_send_button ? "" : "none"
        }
      },
    }
    const settings = {}
    let currentUser = null;
    let currentChat = null;
    // Maps
    let userColors = new Map();
    // Arrays
    const userColorsList = [
      "#E53E3E",
      "#38A169",
      "#805AD5",
      "#D69E2E",
      "#3182CE",
      "#DD6B20",
      "#319795",
      "#B83280",
      "#5A67D8",
      "#718096",
    ];
    let userChats = [];
    // Numbers
    let nextColorIndex = 0;
    let unread = 0;
    let msgsSinceLastShow = 0;
    let msgLastTimestamp = 0;
    // Strings
    let lastMessageDay = null;
    let lastMessageSender = null;
    // Booleans
    let focused = true;
    let isMobile = false;
    //----------------------------------------------//
    // Utility Functions
    function showDesc(text) {
      document.getElementById("loading-page-desc").textContent = text;
    }

    async function showLoadingPage() {
      const loading_page = document.getElementById("loading-page");
      loading_page.classList.remove("hidden");
      await new Promise((r) => setTimeout(r, settings.loading_time < 5 && settings.loading_time >= 0 ? settings.loading_time * 1000 : settingsInfo.loading_time.default * 1000));
      if (settings.loading_time !== 0) {
        loading_page.classList.add("opacity-0");
        setTimeout(() => loading_page.classList.add("hidden"), 500);
      } else {
        loading_page.classList.add("hidden");
      }
    }

    function isJsonString(str) {
      try {
        JSON.parse(str);
      } catch (e) {
        return false;
      }
      return true;
    }

    async function trackRunTime(f) {
      const t1 = Date.now();
      await f()
      const t2 = Date.now();
      const tt = t2 - t1;
      return tt;
    }
    //----------------------------------------------//
    // Scrolling Functions
    function triggerScroll() {
      const element = document.getElementById("message-container")
      if (
        Math.abs(
          element.scrollHeight -
          element.scrollTop -
          element.clientHeight,
        ) < element.clientHeight
      ) {
        scroll()
      }
    }

    function scroll() {
      const element = document.getElementById("message-container")
      element.scrollTo({
        top: element.scrollHeight,
        behavior: "smooth",
      });
    }
    //----------------------------------------------//
    // Chat rendering Functions
    function getColorForUser(username) {
      if (!userColors.has(username)) {
        userColors.set(username, userColorsList[nextColorIndex]);
        nextColorIndex =
          (nextColorIndex + 1) % userColorsList.length;
      }
      return userColors.get(username);
    }

    function appendMessage(message, bulk) {
      if (lastMessageDay !== formatDateToYearMonthDay(new Date(message.timestamp))) {
        lastMessageDay = formatDateToYearMonthDay(new Date(message.timestamp))
        addTimeDisplay(message.timestamp)
      }
      const messageContainer =
        document.getElementById("message-container");
      if (
        message.username == "SERVER" &&
        message.senderId == "SERVER"
      ) {
        const messageElement = document.createElement("div");
        messageElement.classList.add("w-100", "mt-4", "break-keep")
        messageElement.innerHTML = `<div class="p-1 rounded-lg w-80 mx-auto text-center text-sm text-gray-200 bg-${settings.primary_color}-700">
                                                                  <div class="text-sm">
                                                                      ${message.message}
                                                                  </div>
                                                              </div>`;
        messageContainer.appendChild(messageElement);
        lastMessageSender = null;
        if (!bulk) {
          triggerScroll();
        }
        return;
      }
      const isSent = message.username === currentUser?.username;
      let showUsername = message.username !== lastMessageSender || message.timestamp - msgLastTimestamp >= 5 * 60 * 1000;
      if (!showUsername) msgsSinceLastShow++;
      if (msgsSinceLastShow > 20 || showUsername) {
        showUsername = true;
        msgsSinceLastShow = 0;
      }
      const msgOuter = document.createElement("div");
      msgOuter.classList.add("w-100", "flex");
      const messageElement = document.createElement("div");
      messageElement.classList.add(
        "message-bubble",
        "p-2",
        "rounded-lg",
        "max-w-[80%]",
        "min-w-[25ch]",
        "inline-block",
        "w-auto",
        "justify-center",
        "relative" // To position the triangle relative to the message bubble
      );
      if (isSent) {
        messageElement.classList.add(
          "sent",
          "right-0",
          `bg-${settings.secondary_color}-600`,
          "text-white",
          "ml-auto",
        );
        msgOuter.classList.add("justify-end");
        messageElement.style = "border-top-right-radius: 0%;";
      } else {
        messageElement.classList.add(
          "received",
          `bg-${settings.primary_color}-700`,
        );
        messageElement.style = "border-top-left-radius: 0%;";
      }
      if (showUsername) {
        messageElement.classList.add("mt-4");
      } else {
        messageElement.classList.add("mt-2");
      }
      messageElement.innerHTML = `
  ${
    showUsername
      ? `
      <div class="mb-1 flex items-center justify-between">
          <span class="${
            isSent
              ? `text-white text-base font-bold`
              : `text-gray-400 text-base font-bold" style="color: ${getColorForUser(message.username)}`
          }">${isSent ? "You" : message.username}</span>
          <span class="ml-5 text-sm text-gray-300">
            ${getTimestamp(message.timestamp)}
          </span>
      </div>`
      : ""
  }
  <div class="text-base text-wrap break-words ${isSent ? "text-white" : "text-white"}">
    ${message.message}
  </div>
`;
      msgOuter.appendChild(messageElement);
      messageContainer.appendChild(msgOuter);
      lastMessageSender = message.username;
      msgLastTimestamp = message.timestamp;
      if (!bulk) {
        triggerScroll();
      }

      function addTimeDisplay(timestamp) {
        const d = new Date(timestamp);
        const messageElement = document.createElement("div");
        messageElement.classList.add("w-100", "mt-4", "break-keep")
        messageElement.innerHTML = `<div class="p-1 rounded-lg w-40 mx-auto text-center text-sm text-gray-100 bg-${settings.primary_color}-500">
                                                                  <div class="text-sm">
                                                                      ${d.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" })}
                                                                  </div>
                                                              </div>`;
        document.getElementById("message-container").appendChild(messageElement);
        lastMessageSender = null;
      }

      function formatDateToYearMonthDay(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0"); // Month is 0-based, so add 1
        const day = String(date.getDate()).padStart(2, "0"); // Pad single-digit days with leading zero
        return `${year}${month}${day}`; // Format as yyyyMMdd
      }
    }

    function getTimestamp(timestamp) {
      const d = new Date(timestamp);
      const now = new Date();
      // Helper function to format date as dd/mm/yy hh:mm
      function formatDate(date) {
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = String(date.getFullYear()).slice(2); // Get last 2 digits of year
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        return `${day}/${month}/${year} ${hours}:${minutes}`;
      }
      // Check if the date is today
      const isSameDay = d.toDateString() === now.toDateString();
      if (isSameDay) {
        return formatDate(d).slice(9); // Only return the time part (hh:mm)
      }
      // Check if the date is yesterday
      const yesterday = new Date(now);
      yesterday.setDate(now.getDate() - 1);
      const isYesterday = d.toDateString() === yesterday.toDateString();
      if (isYesterday) {
        return `Yesterday at ${formatDate(d).slice(9)}`; // Only return the time part (hh:mm)
      }
      // Check if the date is within the past 7 days but not today or yesterday
      const weekAgo = new Date(now);
      weekAgo.setDate(now.getDate() - 7);
      if (d > weekAgo) {
        // Get the day of the week (e.g., "Monday")
        const dayOfWeek = d.toLocaleString("en-us", {
          weekday: "long"
        });
        return `${dayOfWeek} at ${formatDate(d).slice(9)}`; // Return "Day at hh:mm"
      }
      // If the date is older than a week, return the formatted date (dd/mm/yy hh:mm)
      return formatDate(d);
    }

    function renderChatList() {
      const chatList = document.querySelector(".chat-list");
      chatList.innerHTML = "";
      document.getElementById("chat-details").innerHTML =
        getChatDetails(currentChat);
      userChats.sort((a,b) => {
        return b.userLastMessageTimestamp - a.userLastMessageTimestamp;
      });
      userChats.forEach((chat) => {
        const chatElement = document.createElement("div");
        chatElement.classList.add(
          "chat-item",
          "p-4",
          "border-b",
          `border-${settings.primary_color}-700`,
          "cursor-pointer",
          `active:bg-${settings.primary_color}-600`
        );
        if (currentChat && currentChat?.id === chat.id) {
          chatElement.classList.add(`bg-${settings.primary_color}-700`);
        }
        const messageSender = chat.lastMessage ?
          chat.lastMessage.username + ": " :
          ""
        const lastMessage = chat.lastMessage ?
          chat.lastMessage.message :
          "No messages yet";
        chatElement.innerHTML = `
                                            <div class="font-semibold text-wrap break-keep overflow-hidden truncate flex items-center justify-between"><span class="text-white text-base font-bold">${chat.name.slice(0,25)}${chat.name.length>25?"...":""}</span><span class="ml-5 text-sm text-gray-300">${chat?.lastMessage?.timestamp ? getTimestamp(chat.lastMessage.timestamp) : ""}</span></div>
                                            <div class="text-sm text-gray-400 text-wrap break-keep overflow-hidden truncate">${messageSender}${lastMessage.slice(0,20)}${lastMessage.length>20?"...":""}</div>
                                            <div class="text-xs text-gray-500 text-wrap break-keep overflow-hidden truncate">${chat.participants.length} member${chat.participants.length>1?"s":""}</div>
                                        `;
        chatElement.addEventListener("click", () => {
          switchToChat(chat);
          document.getElementById("chat-details").innerHTML =
            getChatDetails(chat);
        });
        chatList.appendChild(chatElement);
      });
    }

    function getChatDetails(chat) {
      if (chat) {
        return chat.participantsUsernames.sort((a, b) => {
            if (a.id === chat.admin.id) return -1;
            if (b.id === chat.admin.id) return 1;
            if (a.id === currentUser.id) return -1;
            if (b.id === currentUser.id) return 1;
            return 0;
          })
          .map((p) => {
            return `
                                      <div class="flex justify-between items-center mb-2 p-3 bg-${settings.primary_color}-700 rounded">
                                          <div class="inline-flex items-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-5 w-5 mr-3 text-gray-400">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                          <span class="text-white font-medium">${p.username}</span></div>
                                          <div class="flex items-center gap-2">
                                              <span class="text-gray-400 text-sm">ID: ${p.id}</span>
                                              ${p.id === chat.admin.id?
                                              `
                                              <span class="bg-red-600 text-white text-xs font-semibold px-2 py-1 rounded">Admin</span>`:
                                              `${p.id === currentUser.id?`
                                                                              <button class="btn bg-red-900 text-white text-xs font-semibold px-2 py-1 rounded" onclick="leaveChat()">Leave</button>`:`${p.id !== chat.admin.id && currentUser.id === chat.admin.id?`<button class="btn bg-red-900 text-white text-xs font-semibold px-2 py-1 rounded" onclick="removeUser('${p.id}','${p.username}')">Remove</button>`:""}`}
                                                                              `}
                                          </div>
                                      </div>`
          }).join("")
      } else {
        return "";
      }
    }
    //----------------------------------------------//
    // Chat interaction Functions
    async function removeUser(id, username) {
      const confirmed = await createConfirmModal(`Are you sure to remove ${username} from the chat? `)
      const chatId = currentChat?.id;
      if (confirmed && chatId) {
        socket.emit("remove_user_from_chat", {
          chatId,
          userIdToRemove: id
        })
      }
    }

    function leaveChat() {
      if (currentChat) {
        socket.emit("leave_chat", {
          chatId: currentChat.id
        });
      }
    }

    function switchToChat(chat) {
      if (isMobile) {
        mobileSwitchToPane(2)
      }
      msgsSinceLastShow = 0;
      msgLastTimestamp = 0;
      lastMessageDay = null;
      unread = 0
      document.title = "Chat";
      document.getElementById("message-container").innerHTML = "";
      document
        .getElementById("chat-header-whole")
        .classList.remove("hidden");
      document.getElementById("form-div").classList.remove("hidden");

      document.getElementById("chat-header").classList.remove("hidden")
      document.getElementById("chat-header-members").classList.remove("hidden")
      document.getElementById("message-container").classList.add("overflow-y-auto")
      document.getElementById("message-container").classList.remove("overflow-y-hidden")
      currentChat = chat;
      socket.emit("join_chat", {
        chatId: chat.id
      });
      document.getElementById("chat-details").innerHTML =
        getChatDetails(chat);
      const isAdmin = chat.admin.id === currentUser.id;
      if (isAdmin) {
        document.getElementById("delete-chat-btn").disabled =
          false;
        document.getElementById("delete-chat-btn").classList.remove("hidden");
      } else {
        document.getElementById("delete-chat-btn").disabled =
          true;
        document.getElementById("delete-chat-btn").classList.add("hidden");
      }
      document.getElementById("chat-title").textContent =
        chat.name;
      document.getElementById("settings-chat-name").textContent = chat.name;
      document.getElementById("chat-members").textContent =
        chat.participants.length;
      document.getElementById("settings-chat-members").textContent = chat.participants.length;
      renderChatList()
    }

    function toHome() {
      socket.emit("to_home");
      currentChat = null;
      renderChatList()
      document.getElementById("message-container").innerHTML =
        userChats.length == 0 ?
        `<div class="flex flex-col items-center justify-center h-screen bg-${settings.primary_color}-900 text-white">
                                       <h1 class="text-3xl font-bold mb-4 relative">Skibidi Chat<span class="absolute inline-block align-text-top ml-3 px-2 py-1 text-base font-semibold text-white bg-${settings.secondary_color}-600 rounded-full">${`${version}`}
</span></h1>
                                       <p class="text-xl mb-2">To start, create a new chat or ask other users to add you to a existing chat.</p>
                                       <p class="text-sm">Made by <a href="https://github.com/skiibiidee/">@skiibiidee</a></p>
                                   </div>` :
        `<div class="flex flex-col items-center justify-center h-screen bg-${settings.primary_color}-900 text-white">
                                       <p class="text-3xl font-bold mb-4 relative">Skibidi Chat<span class="absolute inline-block align-text-top ml-3 px-2 py-1 text-base font-semibold text-white bg-${settings.secondary_color}-600 rounded-full">${`${version}`}
</span></p>
                                       <h1 class="text-4xl font-semi-bold mb-4">Welcome Back</h1>
                          <a class="px-4 py-2 bg-${settings.secondary_color}-700 rounded-5 rounded mb-3 mt-2" style="text-decoration:none;" href="${rootUrl}/download" target="_blank">Download html file</a>
                                       <p class="text-sm">Made by <a href="https://github.com/skiibiidee/">@skiibiidee</a></p>
                                   </div>`;
      document.getElementById("form-div").classList.add("hidden");
      document.getElementById("settings-modal").classList.add("hidden")
      document.getElementById("user-settings-modal").classList.add("hidden")
      document.getElementById("chat-header").classList.add("hidden")
      document.getElementById("chat-header-members").classList.add("hidden")
      document.getElementById("message-container").classList.remove("overflow-y-auto")

      if (!isMobile) {
        document
          .getElementById("chat-header-whole")
          .classList.add("hidden");
      } else {
        document
          .getElementById("chat-header-whole")
          .classList.remove("hidden");

      }

      document.getElementById("message-container").classList.add("overflow-y-hidden")

      document.getElementById("chat-title").textContent =
        "Chat Name";
      document.getElementById(
        "chat-members",
      ).textContent = "0";
      document.getElementById("settings-chat-members").textContent = "0";
      document.getElementById("settings-chat-name").textContent = "Chat Name";
    }
    //----------------------------------------------//
    // Popup modals functions
    function showToast(message) {
      const toastContainer = document.getElementById("toast-container")
      const toast = document.createElement("div");
      const toastId = "toast-" + Date.now();
      toast.id = toastId;
      toast.className = `flex bg-opacity-70 items-center justify-center bg-${settings.primary_color}-800 text-white px-4 py-2 rounded-lg shadow-lg mb-2 animate-fade-in group`;
      toast.style.fontSize = settings.toast_size + "px"
      const textSpan = document.createElement("span");
      textSpan.className = "inline-flex flex-grow"
      textSpan.textContent = message;
      const closeBtn = document.createElement("button");
      closeBtn.className = `inline-flex ml-auto text-white rounded-full items-center justify-center opacity-${settings.toast_close_btn_initial_opacity*100} group-hover:opacity-100 transition-opacity`;
      closeBtn.style = `width: ${settings.toast_size}px; height: ${settings.toast_size}px;`
      closeBtn.addEventListener("click", () => {
        toast.remove();
      });
      closeBtn.innerHTML = "&times;";
      toast.appendChild(textSpan);
      toast.appendChild(closeBtn);
      toastContainer.appendChild(toast);
      setTimeout(() => {
          const toastElement = document.getElementById(toastId);
          if (toastElement) {
            toastElement.classList.add("animate-fade-out");
            setTimeout(() => {
              if (document.getElementById(toastId)) {
                toastContainer.removeChild(toastElement);
              }
            }, 200);
          }
        },
        settings.toast_duration * 1000);
    }

    function createConfirmModal(message) {
      return new Promise((resolve) => {
        const modal = document.createElement("div");
        modal.id = "confirm-modal";
        modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
        const modalContent = `
            <div class="bg-${settings.primary_color}-800 p-6 rounded-lg max-w-lg w-full">
                <div class="mb-4">
                    <h2 class="text-xl font-bold text-white">${message}</h2>
                </div>
                <div class="flex justify-end gap-2">
                    <button 
                        id="confirm-modal-cancel" 
                        class="bg-${settings.primary_color}-600 hover:bg-${settings.primary_color}-700 text-white font-semibold py-2 px-4 rounded transition duration-200"
                    >
                        Cancel
                    </button>
                    <button 
                        id="confirm-modal-confirm" 
                        class="bg-${settings.secondary_color}-600 hover:bg-${settings.secondary_color}-700 text-white font-semibold py-2 px-4 rounded transition duration-200"
                    >
                        Confirm
                    </button>
                </div>
            </div>
        `;
        modal.innerHTML = modalContent;
        document.body.appendChild(modal);
        document.getElementById("confirm-modal-confirm").addEventListener("click", () => {
          document.body.removeChild(modal);
          resolve(true);
        });
        document.getElementById("confirm-modal-cancel").addEventListener("click", () => {
          document.body.removeChild(modal);
          resolve(false);
        });
        modal.addEventListener("click", (e) => {
          if (e.target.id === "confirm-modal") {
            document.body.removeChild(modal);
            resolve(false);
          }
        });
      });
    }

    function createPromptModal(message, defaultValue = "", maxLength = 250) {
      return new Promise((resolve) => {
        const modal = document.createElement("div");
        modal.id = "prompt-modal";
        modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
        const modalContent = `
            <div class="bg-${settings.primary_color}-800 p-6 rounded-lg max-w-lg w-full">
                <div class="mb-4">
                    <h2 class="text-xl font-bold text-white mb-4">${message}</h2>
                    <input 
                        type="text" 
                        id="prompt-modal-input"
                        class="w-full p-3 border border-${settings.primary_color}-600 bg-${settings.primary_color}-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-${settings.secondary_color}-500 transition duration-200"
                        value=""
                        placeholder="${defaultValue}"
                        maxlength="${maxLength}"
                    />
                </div>
                <div class="flex justify-end gap-2">
                    <button 
                        id="prompt-modal-cancel" 
                        class="bg-${settings.primary_color}-600 hover:bg-${settings.primary_color}-700 text-white font-semibold py-2 px-4 rounded transition duration-200"
                    >
                        Cancel
                    </button>
                    <button 
                        id="prompt-modal-submit" 
                        class="bg-${settings.secondary_color}-600 hover:bg-${settings.secondary_color}-700 text-white font-semibold py-2 px-4 rounded transition duration-200"
                    >
                        Submit
                    </button>
                </div>
            </div>
        `;
        modal.innerHTML = modalContent;
        document.body.appendChild(modal);
        const input = document.getElementById("prompt-modal-input");
        input.focus();

        function handleSubmit() {
          const value = document.getElementById("prompt-modal-input").value;
          document.body.removeChild(modal);
          resolve(value || defaultValue);
        }
        document.getElementById("prompt-modal-submit").addEventListener("click", handleSubmit);
        document.getElementById("prompt-modal-cancel").addEventListener("click", () => {
          document.body.removeChild(modal);
          resolve(null);
        });
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            handleSubmit();
          }
        });
        modal.addEventListener("click", (e) => {
          if (e.target.id === "prompt-modal") {
            document.body.removeChild(modal);
            resolve(null);
          }
        });
      });
    }
    //----------------------------------------------//
    // Setup Functions
    function startFocusPolling() {
      setInterval(() => {
        if (focused !== document.hasFocus()) {
          focused = document.hasFocus();
          if (focused) {
            unread = 0;
            document.title = "Chat";
          }
        }
      }, 1000)
    }

    function prepareUserLogin() {
      const savedUsername = localStorage.getItem("chatapp:username");
      const savedPassword = localStorage.getItem("chatapp:password");
      if (savedUsername && savedPassword) {
        document.getElementById("username").value = savedUsername;
        document.getElementById("password").value = savedPassword;
      }
    }

    function setHtmlContentListeners_loginPage() {
      document
        .getElementById("login-btn")
        .addEventListener("click", () => {
          const username = DOMPurify.sanitize(document.getElementById("username").value);
          const password = DOMPurify.sanitize(document.getElementById("password").value);
          if ( username.length < 4 ){
            showToast("Username too short. Username must be > 4 characters.")
          } else {
            socket.emit("login", {
              username,
              password,
            });
            localStorage.setItem("chatapp:username", username);
            localStorage.setItem("chatapp:password", password);
          }
          });
      document
        .getElementById("register-btn")
        .addEventListener("click", () => {
          const username = DOMPurify.sanitize(document.getElementById("username").value);
          const password = DOMPurify.sanitize(document.getElementById("password").value);
          if ( username.length < 4 ){
            showToast("Username too short. Username must be > 4 characters.")
          } else {
            socket.emit("register", {
              username,
              password,
            });
            localStorage.setItem("chatapp:username", username);
            localStorage.setItem("chatapp:password", password);
          }
        });
    }

    function setHtmlContentListeners_mainChatPage() {
      document
        .getElementById("create-chat-btn")
        .addEventListener("click", async () => {
          const chatName = await createPromptModal("Enter chat name:", settings.default_chat_name, 30);
          if (chatName) {
            socket.emit("create_chat", {
              name: chatName.slice(0, 30)
            });
          }
        });
      document
        .getElementById("home-btn")
        .addEventListener("click", () => {
          if (isMobile) {
            toHome();
            mobileSwitchToPane(2);
            return;
          }
          toHome();
        })
      document
        .getElementById("username-display-btn")
        .addEventListener("click", () => {
          document
            .getElementById("user-settings-modal")
            .classList.remove("hidden");
        })
    }

    function setHtmlContentListeners_chatContainer() {
      document
        .getElementById("chat-header")
        .addEventListener("click", () => {
          if (!currentChat) return;
          document
            .getElementById("settings-modal")
            .classList.remove("hidden");
        });
      document
        .getElementById("message-form")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          unread = 0;
          document.title = "Chat";
          const messageInput =
            document.getElementById("message-input");
          const message = messageInput.value.trim().slice(0, 250);
          if (message && currentUser) {
            socket.emit("send_message", {
              message,
            });
            messageInput.value = "";
          }
        });
      document
        .getElementById("downArrowBtn")
        .addEventListener("click", () => {
          scroll();
        })
      document.getElementById("message-container")
        .addEventListener("scroll", (event) => {
          const downArrowBtn = document
            .getElementById("downArrowBtn");
          const messageContainer = document.getElementById("message-container")
          const scrolledAllTheWay = messageContainer.scrollHeight -
            messageContainer.scrollTop -
            messageContainer.clientHeight <= 0;
          if (scrolledAllTheWay) {
            downArrowBtn.classList.add("hidden");
          } else {
            downArrowBtn.classList.remove("hidden");
          }
        })
      document.body.addEventListener("contextmenu", function(e) {
        if (settings.prevent_right_click) {
          e.preventDefault();
        }
      });
    }

    function setHtmlContentListeners_chatSettingsModal() {
      document
        .getElementById("close-settings-btn")
        .addEventListener("click", () => {
          document
            .getElementById("settings-modal")
            .classList.add("hidden");
        });
      document.getElementById("edit-name-btn").addEventListener("click", async () => {
        if (currentChat) {
          const newName = await createPromptModal("Enter chat name:", settings.default_chat_name, 30);
          if (newName) {
            const confirmed = await createConfirmModal(`Are you sure you want to change the chat name to "${newName.slice(0, 30)}"?`);
            if (confirmed) {
              socket.emit("edit_chat_name", {
                newName: newName.slice(0, 30),
                chatId: currentChat.id
              });
            }
          }
        }
      })
      document
        .getElementById("add-user-btn")
        .addEventListener("click", async () => {
          const userId = await createPromptModal("Enter userid to add:", "", 32);
          if (userId && currentChat) {
            socket.emit("add_user_to_chat", {
              chatId: currentChat.id,
              userId: userId.trim().slice(0, 11),
            });
          }
        });
      document
        .getElementById("delete-chat-btn")
        .addEventListener("click", async () => {
          const confirmed = await createConfirmModal("Are you sure you want to delete this chat?");
          if (confirmed) {
            if (currentChat) {
              socket.emit("delete_chat", {
                chatId: currentChat.id,
              });
            }
          }
        });
    }

    function setHtmlContentListeners_userSettingsModal() {
      const settingsContainer = document.getElementById("settings-container");
      const fullscreenBtn = document.getElementById("fullscreen-btn");
      const settingsContent = document.getElementById("settings-content")
      fullscreenBtn.addEventListener("click", () => {
        const isFullscreen = settingsContainer.classList.contains("fixed");

        if (isFullscreen) {
          settingsContainer.classList.remove("fixed", "bg-black", "bg-opacity-50", "top-0", "left-0", "w-screen", "h-screen", "z-50");
          settingsContainer.classList.add("border", "rounded-lg", "mb-6");
          settingsContent.classList.add("max-h-24");
          fullscreenBtn.textContent = "Full Screen";
        } else {
          settingsContainer.classList.add("fixed", "bg-black", "bg-opacity-50", "top-0", "left-0", "w-screen", "h-screen", "z-50");
          settingsContainer.classList.remove("border", "rounded-lg", "mb-6");
          settingsContent.classList.remove("max-h-24");
          fullscreenBtn.textContent = "Exit Full Screen";
        }
      });
      document
        .getElementById("logout-btn")
        .addEventListener("click", () => {
          socket.disconnect();
          socket.connect();
          document
            .getElementById("chat-page")
            .classList.add("hidden");
          document
            .getElementById("settings-modal")
            .classList.add("hidden");
          document
            .getElementById("user-settings-modal")
            .classList.add("hidden");
          document
            .getElementById("login-page")
            .classList.remove("hidden");
          showToast("Logged out.");
        });
      document
        .getElementById("delete-account-btn")
        .addEventListener("click", async () => {
          const confirmed = await createConfirmModal("Are you sure you want to delete your account? All chats where you are the admin will be deleted.")
          if (confirmed) {
            socket.emit("delete_account");
          }
        });
      document
        .getElementById("reset-settings-btn")
        .addEventListener("click", async () => {
          const confirmed = await createConfirmModal("Are you sure you want to reset all settings to default?");
          if (confirmed) {
            Object.keys(settings).forEach((key) => {
              settings[key] = settingsInfo[key].default;
              const settingInput = document.getElementById(`setting:${key}`);
              if (settingInput) {
                switch (settingsInfo[key].type) {
                  case "boolean":
                    settingInput.checked = settings[key];
                    break;
                  case "string":
                    settingInput.value = settings[key];
                    break;
                  case "number":
                    settingInput.value = settings[key];
                    break;
                  case "drop":
                    settingInput.value = settings[key];
                }
              }
              if (settingsInfo[key].handle) {
                settingsInfo[key].handle(false);
              }
            })
            localStorage.setItem("chatapp:settings", JSON.stringify(settings));
            showToast("Settings reset.");
          }
        })
      document
        .getElementById("settings-modal-close-btn")
        .addEventListener("click", () => {
          document
            .getElementById("user-settings-modal")
            .classList.add("hidden");
        })

    }

    function setSocketEvents_data() {
      socket.on("version", async (v) => {
        if (v !== version) {
          if (rootUrl !== "") {
            const confirmed = await createConfirmModal(`Client and Server version mismatch. Server running ${v} while client on ${version}. Download new version from "${rootUrl}"?`);
            if (confirmed) {
              window.open(`${rootUrl}/download`, target = "_blank");
            }
          } else {
            const confirmed = await createConfirmModal(`Client out of date. Server running ${v} while client on ${version}. Reload?`);
            if (confirmed) {
              window.location.reload();
            }
          }
        }
      })
      socket.on("connect_error", () => {
        showToast("Failed to connect. Retrying...");
        setTimeout(() => socket.connect(), 3000);
      });
      socket.on("connect", () => {
        console.log("Connected to the server.");
        showToast("Connected to server.")
        document
          .getElementById("chat-page")
          .classList.add("hidden");
        document
          .getElementById("login-page")
          .classList.remove("hidden");
        currentUser = null;
        currentChat = null;
        userChats = [];
        unread = 0;
        msgsSinceLastShow = 0;
        msgLastTimestamp = 0;
        lastMessageDay = null;
        document.title = `Chat${unread !== 0 ? ` (${unread})` : ""}`;
        userColors = new Map();
        const savedUsername = localStorage.getItem("chatapp:username");
        const savedPassword = localStorage.getItem("chatapp:password");
        if (savedUsername && savedPassword) {
          document.getElementById("username").value = savedUsername;
          document.getElementById("password").value = savedPassword;
        }
        document.getElementById("register-btn").disabled = false;
        document.getElementById("login-btn").disabled = false;
      })
      socket.on("chats_list", (chats) => {
        if (userChats.length == 0) {
          userChats = chats;
          if (!isMobile) {
            toHome();
          } else {
            toHome();
            mobileSwitchToPane(1)
          }
        } else {
          userChats = chats;
        }
        const index = userChats.findIndex((chat) => chat.id === currentChat?.id)
        if (index > -1) {
          currentChat = userChats[index];
          document.getElementById("chat-title").textContent =
            currentChat.name;
          document.getElementById(
            "chat-members",
          ).textContent = currentChat.participants.length;
          document.getElementById("settings-chat-members").textContent = currentChat.participants.length;
          document.getElementById("settings-chat-name").textContent = currentChat.name;
        }
        renderChatList();
      });
      socket.on("chat_messages", ({
        chatId,
        messages
      }) => {
        if (currentChat && currentChat?.id === chatId) {
          const messageContainer =
            document.getElementById("message-container");
          messageContainer.innerHTML = "";
          lastMessageSender = null;
          messages.forEach((message) => {
            appendMessage(message, true);
          });
          setTimeout(scroll, 50)
        }
      });
      socket.on("message_received", ({
        chatId,
        message
      }) => {
        if (currentChat && currentChat?.id === chatId) {
          appendMessage(message);
          if (!document.hasFocus()) {
            unread++;
            document.title = `Chat${unread !== 0 ? ` (${unread})` : ""}`;
          }
        }
      });
    }

    function setSocketEvents_responses() {
      socket.on("authenticated", (user) => {
        currentUser = user;
        document.getElementById("login-page").classList.add("hidden");
        document.getElementById("chat-page").classList.remove("hidden");
        document.getElementById("user-info").textContent =
          `${user.username}`;
        getColorForUser(user.username);
        document.getElementById("settings-username-display").textContent = user.username;
        document.getElementById("settings-user-id").textContent = user.id;
        document.getElementById("settings-user-creation").textContent = new Date(user.creationTime).toString();
        if (!isMobile) {
          toHome();
        } else {
          toHome();
          mobileSwitchToPane(1);
        }
        showToast("Logged in successfully.");
      });
      socket.on("registered", (user) => {
        currentUser = user;
        document.getElementById("login-page").classList.add("hidden");
        document.getElementById("chat-page").classList.remove("hidden");
        document.getElementById("user-info").textContent =
          `${user.username}`;
        getColorForUser(user.username);
        document.getElementById("settings-username-display").textContent = user.username;
        document.getElementById("settings-user-id").textContent = user.id;
        document.getElementById("settings-user-creation").textContent = new Date(user.creationTime).toString();
        if (!isMobile) {
          toHome();
        } else {
          toHome();
          mobileSwitchToPane(1)
        }
        showToast("Registered and logged in successfully.")
      });
      socket.on("registration_failed", () => {
        showToast("Registration failed. Try another username.");
      });
      socket.on("authentication_failed", () => {
        showToast("Authentication failed. Wrong password or username.");
      });
      socket.on("user_added", (data) => {
        const {
          chatId,
          chat,
          user
        } = data;
        const index = userChats.findIndex((chat) => chat.id === currentChat?.id)
        if (index > -1) {
          userChats[index] = chat;
          currentChat = userChats[index];
          document.getElementById("chat-title").textContent =
            currentChat.name;
          document.getElementById(
            "chat-members",
          ).textContent = currentChat.participants.length;
          document.getElementById("settings-chat-members").textContent = currentChat.participants.length;
        }
        renderChatList();
        document
          .getElementById("settings-modal")
          .classList.add("hidden");
        showToast(`User ${user.username} has been added to ${chatId}.`)
      });
      socket.on("add_user_failed", () => {
        showToast("Failed to add user to chat.");
      });
      socket.on("user_removed", (data) => {
        const {
          user,
          chatId
        } = data;
        showToast(`User ${user.username} has been removed from ${chatId}`)
      })
      socket.on("remove_user_failed", (data) => {
        const {
          user,
          chatId
        } = data;
        showToast(`Failed to remove user ${user.username} from ${chatId}`)
      })
      socket.on("removed_from_chat", (data) => {
        const {
          chatId
        } = data;
        showToast(`You have been removed from ${chatId} by the Admin.`)
        if (chatId === currentChat?.id) {
          if (!isMobile) {
            toHome();
          } else {
            toHome();
            mobileSwitchToPane(1)
          }
        }
      })
      socket.on("chat_deleted", ({
        chatId
      }) => {
        showToast(`Chat of id: ${chatId} has been deleted.`);
        document
          .getElementById("settings-modal")
          .classList.add("hidden");
        if (!isMobile) {
          toHome();
        } else {
          mobileSwitchToPane(1)
        }
      });
      socket.on("delete_chat_failed", () => {
        showToast(`Chat of id: ${chatId} failed to delete.`);
      });
      socket.on("chat_created", (chat) => {
        if (userChats.length == 0) {
          userChats.push(chat);
        }
        switchToChat(chat);
      });
      socket.on("chat_failed_to_create", () => {
        showToast(`Failed to create chat.`);
      })
      socket.on("left_chat", ({
        chatId
      }) => {
        showToast(`You left chat of id: ${chatId}.`);
        document
          .getElementById("settings-modal")
          .classList.add("hidden");
        if (!isMobile) {
          toHome();
        } else {
          toHome();
          mobileSwitchToPane(1)
        }
      });
      socket.on("leave_chat_failed", () => {
        showToast(`Failed to leave chat.`);
      });
      socket.on("account_deleted", () => {
        showToast("Account deleted.")
        document.getElementById("logout-btn").click()
      })
      socket.on("account_failed_to_delete", () => {
        showToast("Account failed to delete.")
      })
      socket.on("chat_name_edited", () => {
        showToast("Chat name edited.")
      })
      socket.on("chat_name_editing_failed", () => {
        showToast("Failed to edit chat name.")
      })
    }

    function mobileSwitchToPane(paneNumber) {
      const left_pane = document.getElementById("left-pane");
      const right_pane = document.getElementById("right-pane");
      if (paneNumber === 2) {
        left_pane.style.display = "none";
        right_pane.style.display = "flex";

      } else {
        if (currentChat) {
          toHome();
        }
        left_pane.style.display = "flex";
        right_pane.style.display = "none";
      }
    }

    function prepareMobileCode() {
      const mobile_back_btn = document.getElementById("mobile-back-btn");
      mobile_back_btn.addEventListener("click", () => {
        toHome();
        mobileSwitchToPane(1);
      })

      function changeMobileState() {
        const x = window.matchMedia("(max-width: 600px)");
        if (isMobile !== x.matches) {
          if (x.matches) {
            isMobile = true;

            const left_pane = document.getElementById("left-pane");
            const right_pane = document.getElementById("right-pane");
            left_pane.style.display = "flex";
            right_pane.style.display = "none";
            toHome();

          } else {
            isMobile = false;

            const left_pane = document.getElementById("left-pane");
            const right_pane = document.getElementById("right-pane");
            left_pane.style.display = "flex";
            right_pane.style.display = "flex";
            toHome();
          }
        }
      }

      changeMobileState();

      window.addEventListener("resize", changeMobileState);
    }

    function setHtmlContentListeners_modals() {
      setHtmlContentListeners_chatSettingsModal();
      setHtmlContentListeners_userSettingsModal();
    }

    function setSocketEvents() {
      setSocketEvents_data();
      setSocketEvents_responses();
    }

    function setHtmlContentListeners() {
      setHtmlContentListeners_loginPage();
      setHtmlContentListeners_mainChatPage();
      setHtmlContentListeners_chatContainer();
      setHtmlContentListeners_modals();
    }

    function setHtmlContent() {
      document.getElementById("login-page-version").textContent = version;
    }

    function setAppSettings() {
      const userAppSettingsString = localStorage.getItem("chatapp:settings");
      if (userAppSettingsString && isJsonString(userAppSettingsString)) {
        const userAppSettings = JSON.parse(userAppSettingsString);
        Object.entries(settingsInfo).forEach((entry) => {
          const [key, _] = entry;
          if (Object.keys(userAppSettings).includes(key)) {
            const userAppSettingsValue = userAppSettings[key];
            const settingValue = getSettingValue(key, userAppSettingsValue)
            if (settingValue !== null) {
              settings[key] = settingValue;
              return;
            }
          }
          // Default
          settings[key] = settingsInfo[key].default;
          return;
        });

      } else {
        Object.entries(settingsInfo).forEach((entry) => {
          const [key, value] = entry;
          settings[key] = value.default;
        })
      }

      localStorage.setItem("chatapp:settings", JSON.stringify(settings))

      function getSettingValue(key, settingValue) {
        switch (settingsInfo[key].type) {
          case "number":
            const numberValue = Number(settingValue);
            if (numberValue === "NaN") {
              return null;
            }
            return numberValue;
          case "boolean":
            const booleanValue = [true, false].includes(settingValue) ?
              settingValue :
              null;
            if (booleanValue === null) {
              return null;
            }
            return booleanValue;
          case "string":
            if (settingValue) {
              return settingValue
            }
            return null;
          case "drop":
            if (settingValue) {
              return settingValue
            }
            return null;
        }
        return null;
      }

    }

    function renderAppSettings() {
      const settingsContent = document.getElementById("settings-content");
      Object.keys(settings).forEach((key) => {
        const settingDiv = document.createElement("div");
        settingDiv.className = `flex justify-between items-center border-b border-${settings.primary_color}-700 py-2`;
        const settingLabel = document.createElement("label");
        settingLabel.textContent = settingsInfo[key].name;
        settingLabel.htmlFor = `setting:${key}`;
        settingLabel.classList.add("text-gray-300");
        const parentDiv = document.createElement("div");
        parentDiv.className = "inline-flex items-center ml-5";

        switch (settingsInfo[key].type) {
          case "number":
            const settingInputNumber = document.createElement("input");
            settingInputNumber.id = `setting:${key}`;
            settingInputNumber.type = "number";
            settingInputNumber.step = "0.01";
            settingInputNumber.classList.add("bg-transparent", "border", `border-${settings.primary_color}-600`, "text-gray-200", "text-sm", "rounded-lg", "focus:ring-blue-500", "p-2");
            settingInputNumber.addEventListener("change", () => {
              settings[key] = settingInputNumber.value;
              localStorage.setItem("chatapp:settings", JSON.stringify(settings))
            })
            settingInputNumber.value = settings[key];
            parentDiv.appendChild(settingInputNumber);
            if (settingsInfo[key].handle) {
              settingInputNumber.addEventListener("change", () => {
                settingsInfo[key].handle(false);
              });
              settingsInfo[key].handle(true);
            }
            break;
          case "boolean":
            const settingInputBool = document.createElement("input");
            settingInputBool.id = `setting:${key}`;
            settingInputBool.type = "checkbox";
            settingInputBool.checked = settings[key];
            parentDiv.appendChild(settingInputBool);
            settingInputBool.addEventListener("change", () => {
              settings[key] = settingInputBool.checked;
              localStorage.setItem("chatapp:settings", JSON.stringify(settings))
            })

            const stylizedCheckbox = document.createElement("label");
            stylizedCheckbox.className = "flex items-center cursor-pointer relative";

            settingInputBool.className =
              `peer h-5 w-5 cursor-pointer transition-all appearance-none rounded shadow hover:shadow-md border border-${settings.primary_color}-600 checked:bg-${settings.secondary_color}-600 checked:border-${settings.secondary_color}-600`;

            const checkmark = document.createElement("span");
            checkmark.className =
              "absolute text-white opacity-0 peer-checked:opacity-100 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none";

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("xmlns", "http://www.w3.org/2000/svg");
            svg.classList.add("h-4", "w-4");
            svg.setAttribute("viewBox", "0 0 20 20");
            svg.setAttribute("fill", "currentColor");
            svg.setAttribute("stroke", "currentColor");
            svg.setAttribute("stroke-width", "1");

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("fill-rule", "evenodd");
            path.setAttribute(
              "d",
              "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
            );
            path.setAttribute("clip-rule", "evenodd");
            svg.appendChild(path);
            checkmark.appendChild(svg);

            stylizedCheckbox.appendChild(settingInputBool);
            stylizedCheckbox.appendChild(checkmark);
            parentDiv.appendChild(stylizedCheckbox);

            settingInputBool.addEventListener("change", () => {
              settings[key] = settingInputBool.checked;
              localStorage.setItem("chatapp:settings", JSON.stringify(settings));
            });
            if (settingsInfo[key].handle) {
              settingInputBool.addEventListener("change", () => {
                settingsInfo[key].handle(false);
              });
              settingsInfo[key].handle(true);
            }
            break;
          case "string":
            const settingInputString = document.createElement("input");
            settingInputString.id = `setting:${key}`;
            settingInputString.type = "text";
            settingInputString.classList.add("bg-transparent", "border", `border-${settings.primary_color}-600`, "text-gray-200", "text-sm", "rounded-lg", "focus:ring-blue-500", "p-2");
            settingInputString.addEventListener("change", () => {
              settings[key] = settingInputString.value;
              localStorage.setItem("chatapp:settings", JSON.stringify(settings))
            })
            settingInputString.value = settings[key];
            parentDiv.appendChild(settingInputString);
            if (settingsInfo[key].handle) {
              settingInputString.addEventListener("change", () => {
                settingsInfo[key].handle(false);
              });
              settingsInfo[key].handle(true);
            }
            break;
          case "drop":
            const dropdown = document.createElement("select");
            dropdown.id = `setting:${key}`;
            dropdown.className = `block w-full px-4 py-2 bg-transparent border border-${settings.primary_color}-300 rounded-md`;
            const labelOption = document.createElement("option");
            labelOption.disabled = true;
            labelOption.selected = true;
            labelOption.textContent = "Select a color"
            settingsInfo[key].options.forEach(color => {
              const option = document.createElement('option');
              option.className = "text-black hover:text-black"
              option.value = color;
              option.textContent = color.charAt(0).toUpperCase() + color.slice(1);
              dropdown.appendChild(option);
            });
            dropdown.addEventListener("change", () => {
              settings[key] = dropdown.value;
              localStorage.setItem("chatapp:settings", JSON.stringify(settings))
            })
            dropdown.value = settings[key];
            parentDiv.appendChild(dropdown);
            if (settingsInfo[key].handle) {
              dropdown.addEventListener("change", () => {
                settingsInfo[key].handle(false);
              });
              settingsInfo[key].handle(true);
            }
            break;
        }

        settingDiv.appendChild(settingLabel)
        settingDiv.appendChild(parentDiv)
        settingsContent.appendChild(settingDiv)
      })
    }

    async function runFunctions() {
      setAppSettings();
      renderAppSettings();
      setHtmlContent();
      setHtmlContentListeners();
      setSocketEvents();
      prepareUserLogin();
      startFocusPolling();
      prepareMobileCode();
      showDesc("Starting up...");
      showLoadingPage()
    }
    //----------------------------------------------//
    // Main
    async function main() {
      const setupTime = await trackRunTime(runFunctions)
      showToast(`Chat App loaded in ${setupTime}ms.`);

    }

    window.onload = main;
  </script>
</body>

</html>