<!doctype html>
<html lang="en" class="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chat</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            html {
                font-size: 16px;
            }

            body {
                font-size: 1rem;
            }

            h1 {
                font-size: 2rem;
            }
            h2 {
                font-size: 1.5rem;
            }
            p {
                font-size: 1rem;
            }
            button,
            input,
            select {
                font-size: 1rem;
            }

            @media (min-width: 1200px) {
                html {
                    font-size: 20px;
                }

                .container {
                    max-width: 1140px;
                    padding: 0 2rem;
                }

                h1 {
                    font-size: 3rem;
                }
                h2 {
                    font-size: 2rem;
                }
                p {
                    font-size: 1.25rem;
                }
            }
        </style>
    </head>

    <body
        class="min-h-screen transition-colors duration-300 bg-gray-900 text-white"
    >
        <!-- Login Page -->
        <div
            id="login-page"
            class="min-h-screen flex items-center justify-center p-4"
        >
            <div
                class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md space-y-6"
            >
                <h1 class="text-3xl font-bold text-white text-center">
                    Welcome Back
                </h1>
                <p class="text-gray-400 text-center">
                    Please enter your details
                </p>
                <div class="space-y-4">
                    <div>
                        <label
                            for="username"
                            class="block text-gray-400 font-medium mb-2"
                            >Username</label
                        >
                        <input
                            type="text"
                            id="username"
                            class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                            placeholder="Enter your username"
                            maxlength="32"
                        />
                    </div>
                    <div>
                        <label
                            for="password"
                            class="block text-gray-400 font-medium mb-2"
                            >Password</label
                        >
                        <input
                            type="password"
                            id="password"
                            class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                            placeholder="Enter your password"
                            maxlength="32"
                        />
                    </div>
                    <div class="flex gap-4">
                        <button
                            id="login-btn"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"
                        >
                            Login
                        </button>
                        <button
                            id="register-btn"
                            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"
                        >
                            Register
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Page -->
        <div id="chat-page" class="hidden h-screen flex">
            <!-- Sidebar -->
            <div
                class="w-1/3 bg-gray-800 border-r border-gray-700 flex flex-col"
            >
                <!-- Sidebar Header -->
                <div
                    class="p-4 border-b border-gray-700 flex items-center justify-between"
                >
                    <div class="flex items-center">
                        <div class="text-lg font-semibold">Chats</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-gray-400" id="user-info"></div>
                        <button
                            id="logout-btn"
                            class="text-sm text-red-500 hover:text-red-600 font-medium"
                        >
                            Logout
                        </button>
                    </div>
                </div>

                <!-- Create Chat Button -->
                <button
                    id="create-chat-btn"
                    class="m-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"
                >
                    Create New Chat
                </button>

                <!-- Chat List -->
                <div class="chat-list flex-1 overflow-y-auto">
                    <!-- Chat items will be dynamically inserted here -->
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="w-2/3 flex flex-col">
                <!-- Chat Header -->
                <div
                    class="chat-header bg-gray-800 shadow-sm p-4 flex items-center justify-between"
                >
                    <div class="flex items-center gap-4">
                        <h1 class="text-xl font-semibold">Select a chat</h1>
                        <button
                            id="chat-settings-btn"
                            class="text-gray-400 hover:text-white"
                        >
                            Settings
                        </button>
                    </div>
                    <div class="text-sm text-gray-400">0 members</div>
                </div>

                <!-- Messages Container -->
                <div
                    class="flex-1 bg-gray-900 px-4 py-2 overflow-hidden flex flex-col"
                >
                    <div
                        id="message-container"
                        class="flex-1 overflow-y-auto space-y-4"
                    ></div>
                </div>

                <!-- Message Input -->
                <div
                    id="form-div"
                    class="bg-gray-800 border-t border-gray-700 p-4"
                >
                    <form
                        id="message-form"
                        class="flex gap-3"
                        autocomplete="off"
                    >
                        <input
                            type="text"
                            id="message-input"
                            class="flex-1 p-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                            placeholder="Type your message..."
                            maxlength="250"
                        />
                        <button
                            type="submit"
                            id="send-button"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 rounded-lg transition duration-200"
                        >
                            Send
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Chat Settings Modal -->
        <div
            id="settings-modal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center"
        >
            <div class="bg-gray-800 p-6 m-5 rounded-lg max-w-lg w-full">
                <h2 class="text-xl font-bold mb-4 text-white">Chat Settings</h2>

                <div id="chat-details" class="rounded-lg p-4 max-h-60 overflow-y-auto mb-6">
                </div>

                <div class="space-y-4">
                    <button
                        id="add-user-btn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded"
                    >
                        Add User
                    </button>
                    <button
                        id="leave-chat-btn"
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded"
                    >
                        Leave Chat
                    </button>
                    <button
                        id="delete-chat-btn"
                        class="w-full bg-red-800 hover:bg-red-900 text-white font-bold py-2 px-4 rounded"
                    >
                        Delete Chat
                    </button>
                    <small>note: only admin can delete chat | admin cannot leave chat</small>
                </div>

                <button
                    id="close-settings-btn"
                    class="mt-4 text-gray-400 hover:text-white"
                >
                    Close
                </button>
            </div>
        </div>

        <script>
            const socket = io();
            socket.on("connect", () => {
                console.log("Connected to the server.");

                currentUser = null;
                document
                    .getElementById("chat-page")
                    .classList.add("hidden");
                document
                    .getElementById("login-page")
                    .classList.remove("hidden");
                currentUser = null;
                currentChat = null;
                userChats = [];
                unread = 0;
                userColors = new Map();
                const savedUsername = localStorage.getItem("username");
                const savedPassword = localStorage.getItem("password");
                if (savedUsername && savedPassword) {
                    document.getElementById("username").value = savedUsername;
                    document.getElementById("password").value = savedPassword;
                }
            })
            let currentUser = null;
            let currentChat = null;
            let userChats = [];
            let unread = 0;
            let userColors = new Map();

            const userColorsList = [
                "#E53E3E",
                "#38A169",
                "#805AD5",
                "#D69E2E",
                "#3182CE",
                "#DD6B20",
                "#319795",
                "#B83280",
                "#5A67D8",
                "#718096",
            ];

            let nextColorIndex = 0;
            let lastMessageSender = null;

            const savedUsername = localStorage.getItem("username");
            const savedPassword = localStorage.getItem("password");
            if (savedUsername && savedPassword) {
                document.getElementById("username").value = savedUsername;
                document.getElementById("password").value = savedPassword;
            }

            function triggerScroll(element) {
                if (
                    Math.abs(
                        element.scrollHeight -
                            element.scrollTop -
                            element.clientHeight,
                    ) < element.clientHeight
                ) {
                    element.scrollTo({
                        top: element.scrollHeight,
                        behavior: "smooth",
                    });
                }
            }
            function getColorForUser(username) {
                if (!userColors.has(username)) {
                    userColors.set(username, userColorsList[nextColorIndex]);
                    nextColorIndex =
                        (nextColorIndex + 1) % userColorsList.length;
                }
                return userColors.get(username);
            }

            function appendMessage(message) {
                const messageContainer =
                    document.getElementById("message-container");
                if (
                    message.username == "SERVER" &&
                    message.senderId == "SERVER"
                ) {
                    const messageElement = document.createElement("div");
                    messageElement.innerHTML = `<div class="p-1 rounded-lg w-80 mx-auto text-center text-sm text-gray-200 bg-gray-700">
  <div class="text-sm">
    ${message.message}
  </div>
</div>

                          `;
                    messageContainer.appendChild(messageElement);
                    lastMessageSender = null;
                    triggerScroll(messageContainer);
                    return;
                }
                const isSent = message.username === currentUser?.username;
                const showUsername = message.username !== lastMessageSender;

                const messageElement = document.createElement("div");
                messageElement.classList.add(
                    "message-bubble",
                    "p-3",
                    "rounded-lg",
                    "max-w-[80%]",
                );

                if (isSent) {
                    messageElement.classList.add(
                        "sent",
                        "ml-auto",
                        "bg-blue-600",
                        "text-white",
                    );
                } else {
                    messageElement.classList.add("received", "bg-gray-700");
                }

                messageElement.innerHTML = `
                              ${
                                  showUsername
                                      ? `
                                  <div class="text-sm mb-1 ${
                                      isSent
                                          ? "text-white font-bold"
                                          : `text-gray-400" style="color: ${getColorForUser(message.username)}"`
                                  }">
                                      ${isSent ? "You" : message.username}
                                  </div>
                              `
                                      : ""
                              }
                              <div class="text-base ${isSent ? "text-white" : "text-white"}">
                                  ${message.message}
                              </div>
                      `;

                messageContainer.appendChild(messageElement);
                lastMessageSender = message.username;
                triggerScroll(messageContainer);
            }

            function renderChatList() {
                const chatList = document.querySelector(".chat-list");
                chatList.innerHTML = "";

                document.getElementById("chat-details").innerHTML =
                    getChatDetails(currentChat);
                userChats.forEach((chat) => {
                    const chatElement = document.createElement("div");
                    chatElement.classList.add(
                        "chat-item",
                        "p-4",
                        "border-b",
                        "border-gray-700",
                        "hover:bg-gray-700",
                        "cursor-pointer",
                    );

                    if (currentChat && currentChat?.id === chat.id) {
                        chatElement.classList.add("bg-gray-700");
                    }

                    const lastMessage = chat.lastMessage
                        ? chat.lastMessage.message
                        : "No messages yet";

                    chatElement.innerHTML = `
                              <div class="font-semibold">${chat.name}</div>
                              <div class="text-sm text-gray-400">Last message: ${lastMessage}</div>
                              <div class="text-xs text-gray-500">${chat.participants.length} members</div>
                          `;

                    chatElement.addEventListener("click", () => {
                        switchToChat(chat);
                        document.getElementById("chat-details").innerHTML =
                            getChatDetails(chat);
                    });

                    chatList.appendChild(chatElement);
                });
            }

            function getChatDetails(chat) {
                if(chat){
                    return chat.participantsUsernames.map((p)=>{
                        return `
                        <div class="flex justify-between items-center mb-2 p-3 bg-gray-700 rounded">
                            <span class="text-white font-medium">${p.username}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400 text-sm">ID: ${p.id}</span>
                                ${p.id === chat.admin.id?`
                                <span class="bg-red-600 text-white text-xs font-semibold px-2 py-1 rounded">Admin</span>`:``}
                            </div>
                        </div>`
                    }).join("")
                }else{
                    return "";
                }
            }

            function switchToChat(chat) {
                document.getElementById("message-container").innerHTML = "";
                document
                    .querySelector(".chat-header")
                    .classList.remove("hidden");
                document.getElementById("form-div").classList.remove("hidden");
                currentChat = chat;
                socket.emit("join_chat", { chatId: chat.id });

                document.getElementById("chat-details").innerHTML =
                    getChatDetails(chat);
                document.getElementById("delete-chat-btn").disabled =
                    chat.admin.id !== currentUser.id;
                document.getElementById("leave-chat-btn").disabled =
                    chat.admin.id === currentUser.id;

                document.querySelector(".chat-header h1").textContent =
                    chat.name;
                document.querySelector(".chat-header .text-sm").textContent =
                    `${chat.participants.length} members`;
            }

            function toHome() {
                currentChat = null;
                document.getElementById("message-container").innerHTML =
                    userChats.length == 0
                        ? `<div class="flex flex-col items-center justify-center h-screen bg-gray-900 text-white">
                         <h1 class="text-5xl font-bold mb-4">Skibidi Chat</h1>
                         <p class="text-xl mb-2">To start, create a new chat or ask other users to add you to a existing chat.</p>
                         <p class="text-sm">Made by <a href="https://github.com/skiibiidee/">@skiibiidee</a></p>
                     </div>`
                        : `<div class="flex flex-col items-center justify-center h-screen bg-gray-900 text-white">
                         <h1 class="text-5xl font-bold mb-4">Welcome Back</h1>
                         <p class="text-xl mb-2">Skibidi Chat is still in development.</p>
                         <p class="text-sm">Made by <a href="https://github.com/skiibiidee/">@skiibiidee</a></p>
                     </div>`;
                document.querySelector(".chat-header").classList.add("hidden");
                document.getElementById("form-div").classList.add("hidden");
            }

            socket.on("chats_list", (chats) => {
                if (userChats.length == 0) {
                    userChats = chats;

                    toHome();
                } else {
                    userChats = chats;
                }

                const index = userChats.findIndex((chat) => chat.id === currentChat?.id)
                if(index > -1){
                    currentChat = userChats[index];
                }
                renderChatList();

            });

            socket.on("chat_messages", ({ chatId, messages }) => {
                if (currentChat && currentChat?.id === chatId) {
                    const messageContainer =
                        document.getElementById("message-container");
                    messageContainer.innerHTML = "";
                    lastMessageSender = null;
                    messages.forEach((message) => {
                        appendMessage(message);
                    });
                }
            });

            socket.on("message_received", ({ chatId, message }) => {
                if (currentChat && currentChat?.id === chatId) {
                    appendMessage(message);
                    if (!document.hasFocus()) {
                        unread++;
                        document.title = `Chat${unread !== 0 ? ` (${unread})` : ""}`;
                    }
                }
            });

            socket.on("authenticated", (user) => {
                currentUser = user;
                document.getElementById("login-page").classList.add("hidden");
                document.getElementById("chat-page").classList.remove("hidden");
                document.getElementById("user-info").textContent =
                    `Logged in as ${user.username}`;
                getColorForUser(user.username);
                toHome();
            });

            socket.on("registered", (user) => {
                currentUser = user;
                document.getElementById("login-page").classList.add("hidden");
                document.getElementById("chat-page").classList.remove("hidden");
                document.getElementById("user-info").textContent =
                    `Logged in as ${user.username}`;
                getColorForUser(user.username);
                toHome();
            });

            socket.on("registration_failed", () => {
                alert("Registration failed. Try another username.");
            });

            socket.on("authentication_failed", () => {
                alert("Authentication failed. Wrong password or username.");
            });

            socket.on("add_user_failed", () => {
                alert("Failed to add user to chat.");
            });

            socket.on("user_added", (data) => {
                const { chatId, userId } = data;
                const chat = userChats.find((chat) => chat.id === chatId);
                if (currentChat && currentChat?.id == chat.id) {
                    document.querySelector(".chat-header h1").textContent =
                        chat.name;
                    document.querySelector(
                        ".chat-header .text-sm",
                    ).textContent = `${chat.participants.length} members`;
                    currentChat = chat
                }
                if (chat) {
                    chat.participants.push(userId);
                    renderChatList();
                }
                
                document
                    .getElementById("settings-modal")
                    .classList.add("hidden");
            });

            socket.on("chat_deleted", ({ chatId }) => {
                alert(`Chat of id: ${chatId} has been deleted.`);

                document
                    .getElementById("settings-modal")
                    .classList.add("hidden");
                toHome();
            });

            socket.on("delete_chat", () => {
                alert(`Chat of id: ${chatId} failed to delete.`);
            });

            socket.on("chat_created", (chat) => {
                if (userChats.length == 0) {
                    userChats.push(chat);
                }
                switchToChat(chat);
            });

            socket.on("left_chat", ({ chatId }) => {
                alert(`You left chat of id: ${chatId}`);

                document
                    .getElementById("settings-modal")
                    .classList.add("hidden");
                toHome();
            });

            socket.on("leave_chat_failed", () => {
                alert(`Failed to leave chat.`);
            });

            document
                .getElementById("login-btn")
                .addEventListener("click", () => {
                    const username = document.getElementById("username").value;
                    const password = document.getElementById("password").value;
                    socket.emit("login", {
                        username,
                        password,
                    });
                    localStorage.setItem("username", username);
                    localStorage.setItem("password", password);
                });

            document
                .getElementById("register-btn")
                .addEventListener("click", () => {
                    const username = document.getElementById("username").value;
                    const password = document.getElementById("password").value;
                    socket.emit("register", {
                        username,
                        password,
                    });
                });

            document
                .getElementById("create-chat-btn")
                .addEventListener("click", () => {
                    const chatName = prompt("Enter chat name:");
                    if (chatName) {
                        socket.emit("create_chat", { name: chatName });
                    }
                });

            document
                .getElementById("chat-settings-btn")
                .addEventListener("click", () => {
                    if (!currentChat) return;
                    document
                        .getElementById("settings-modal")
                        .classList.remove("hidden");
                });

            document
                .getElementById("close-settings-btn")
                .addEventListener("click", () => {
                    document
                        .getElementById("settings-modal")
                        .classList.add("hidden");
                });

            document
                .getElementById("add-user-btn")
                .addEventListener("click", () => {
                    const username = prompt("Enter username to add:");
                    if (username && currentChat) {
                        socket.emit("add_user_to_chat", {
                            chatId: currentChat.id,
                            username: username,
                        });
                    }
                });
            document
                .getElementById("delete-chat-btn")
                .addEventListener("click", () => {
                    if (confirm("Are you sure you want to delete this chat")) {
                        if (currentChat) {
                            socket.emit("delete_chat", {
                                chatId: currentChat.id,
                            });
                        }
                    }
                });

            document
                .getElementById("logout-btn")
                .addEventListener("click", () => {
                    currentUser = null;
                    document
                        .getElementById("chat-page")
                        .classList.add("hidden");
                    document
                        .getElementById("login-page")
                        .classList.remove("hidden");
                    document.getElementById("username").value = "";
                    document.getElementById("password").value = "";
                    localStorage.removeItem("username");
                    localStorage.removeItem("password");
                    socket.disconnect();
                    socket.connect();
                });

            document
                .getElementById("leave-chat-btn")
                .addEventListener("click", () => {
                    if (currentChat) {
                        socket.emit("leave_chat", { chatId: currentChat.id });
                    }
                });

            document
                .getElementById("message-form")
                .addEventListener("submit", (e) => {
                    e.preventDefault();
                    const messageInput =
                        document.getElementById("message-input");
                    const message = messageInput.value.trim().slice(0, 250);
                    if (message && currentUser) {
                        socket.emit("send_message", {
                            message,
                        });
                        messageInput.value = "";
                    }
                });
        </script>
    </body>
</html>
